<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Simulator v12.0 - Amount Input</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0f19; color: #e2e8f0; font-family: 'Inter', 'Noto Sans JP', sans-serif; padding-bottom: 120px; background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 20%); background-attachment: fixed; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; border-radius: 8px; width: 100%; padding: 8px; font-weight: bold; text-align: center; }
        .glass-input:disabled { background: rgba(15, 23, 42, 0.3); color: #64748b; border-color: transparent; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 20px; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: rgba(148, 163, 184, 0.2); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #60a5fa; margin-top: -6px; border: 2px solid #1e293b; }
        .tab-btn { transition: all 0.3s; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; text-align: center; }
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .tab-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; border: 1px solid rgba(255,255,255,0.05); }
        
        @media (min-width: 1024px) {
            .container-grid { display: grid; grid-template-columns: 360px 1fr; gap: 24px; max-width: 1200px; margin: 0 auto; align-items: start; }
            .chart-area { position: sticky; top: 20px; }
            .sub-charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .sticky-result { position: static !important; background: transparent !important; padding: 0 !important; margin-top: 20px; border: none !important; }
            .mobile-chart-only { display: none; }
        }
        .sticky-result { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(11, 15, 25, 0.95); padding: 12px; z-index: 50; border-top: 1px solid rgba(255,255,255,0.1); }
        #chartModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="p-4">

    <header class="mb-6 text-center lg:text-left lg:max-w-[1200px] lg:mx-auto">
        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">FIRE Simulator <span class="text-xs text-gray-500 ml-1">v12.0</span></h1>
    </header>

    <div class="lg:hidden mb-6 mobile-chart-only">
        <div class="glass-card p-2 h-[280px] relative">
            <canvas id="chartCanvasMobile"></canvas>
        </div>
    </div>

    <div class="container-grid">
        <div class="input-column">
            <div id="achievementMobile" class="lg:hidden mb-4"></div>

            <div class="glass-card p-4 mb-5">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-blue-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-blue-300">PROFILE</h2></div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="currentAge" value="35" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨è³‡ç”£ (ä¸‡)</label><input type="number" id="initialAsset" value="1000" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">æ¯æœˆç©ç«‹ (ä¸‡)</label><input type="number" id="monthlyAdd" value="10" class="glass-input"></div>
                    <div><label class="text-[10px] text-yellow-500 block mb-1">ç›®æ¨™é‡‘é¡ (ä¸‡)</label><input type="number" id="targetAsset" value="3000" class="glass-input border-yellow-500/30 text-yellow-100"></div>
                </div>
                <div class="bg-blue-900/20 p-2 rounded-lg flex items-center gap-2">
                    <input type="checkbox" id="coastFireMode" class="w-4 h-4"><label for="coastFireMode" class="text-[10px] font-bold text-blue-200 cursor-pointer">ç›®æ¨™é”æˆã§ç©ç«‹åœæ­¢</label>
                </div>
                <div id="graduationAgeArea" class="hidden mt-2 text-center"><span class="bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded text-[10px] font-bold">ğŸ‰ <span id="graduationAge">0</span>æ­³ã§å’æ¥­</span></div>
            </div>

            <div class="glass-card p-4 mb-5">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center"><div class="w-1 h-4 bg-purple-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-purple-300">PORTFOLIO</h2></div>
                    
                    <div class="flex items-center bg-slate-900/50 rounded-lg p-1">
                        <button onclick="setInputMode('percent')" id="btnModePercent" class="px-2 py-1 text-[10px] font-bold rounded text-white bg-blue-600">ï¼…æŒ‡å®š</button>
                        <button onclick="setInputMode('amount')" id="btnModeAmount" class="px-2 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white">é‡‘é¡æŒ‡å®š</button>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <div id="tabCurrent" onclick="switchTab('current')" class="flex-1 tab-btn tab-active">ä»Šã®è³‡ç”£</div>
                    <div id="tabFuture" onclick="switchTab('future')" class="flex-1 tab-btn tab-inactive">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</div>
                </div>

                <div id="uiPercentMode">
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <button onclick="applyPreset('defensive')" class="bg-emerald-900/30 text-emerald-400 text-[10px] py-2 rounded">ğŸ›¡ï¸ é‰„å£</button>
                        <button onclick="applyPreset('standard')" class="bg-blue-900/30 text-blue-400 text-[10px] py-2 rounded">ğŸ‘‘ ç‹é“</button>
                        <button onclick="applyPreset('aggressive')" class="bg-purple-900/30 text-purple-400 text-[10px] py-2 rounded">ğŸš€ çˆ†ç›Š</button>
                    </div>
                    <div class="mb-5 bg-slate-800 rounded-full h-2 overflow-hidden"><div id="totalProgressBar" class="h-full bg-blue-500 transition-all" style="width: 100%"></div></div>
                    <div id="containerSlidersCurrent" class="block"><div id="slidersCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerSlidersFuture" class="hidden"><div id="slidersFuture" class="grid grid-cols-2 gap-3"></div></div>
                </div>

                <div id="uiAmountMode" class="hidden">
                    <p class="text-[10px] text-yellow-500 mb-2 text-center bg-yellow-900/20 py-1 rounded">é‡‘é¡ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€Œç¾åœ¨è³‡ç”£ã€ã¨ã€Œï¼…ã€ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</p>
                    <div id="containerInputsCurrent" class="block"><div id="inputsCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerInputsFuture" class="hidden"><div id="inputsFuture" class="grid grid-cols-2 gap-3"></div></div>
                    <div class="mt-4 text-center">
                        <p class="text-[10px] text-gray-400">åˆè¨ˆ</p>
                        <p class="text-xl font-black text-white"><span id="amountModeTotal">0</span> <span class="text-xs">ä¸‡å††</span></p>
                    </div>
                </div>
                
                <div class="mt-5 pt-4 border-t border-slate-700/50 grid grid-cols-2 gap-3 text-center">
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold mb-1">ç¾åœ¨ã®PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-blue-400"><span id="tabRetCurrent">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskCurrent">0.0</span>%</span></div>
                    </div>
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold">ç©ç«‹PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-green-400"><span id="tabRetFuture">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskFuture">0.0</span>%</span></div>
                    </div>
                </div>
            </div>

            <div class="mb-5 glass-card p-4">
                <p class="text-[10px] text-gray-400 mb-2 text-center font-bold">ASSET SPEC (10 YEARS)</p>
                <div class="flex justify-center gap-8 text-center">
                    <div><p class="text-[9px] text-gray-500">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</p><p class="text-2xl font-black text-white"><span id="specTotalRet">0.0</span>%</p></div>
                    <div><p class="text-[9px] text-gray-500">æœ€å¤§ãƒªã‚¹ã‚¯</p><p class="text-2xl font-black text-red-500"><span id="specTotalCrash">0.0</span>%</p></div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-indigo-500/20">
                <h2 class="text-xs font-bold text-indigo-300 mb-3">EXIT & CRASH</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawAge" value="60" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400">æš´è½è¨­å®š</label><select id="crashCount" class="glass-input text-xs"><option value="0">ãªã—</option><option value="2">2å›</option><option value="5" selected>5å›</option><option value="8">8å›</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">å–å´©ç‡(%)</label><input type="number" id="num_withdrawRate" value="4.0" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400">æš´è½æ™‚æœŸ</label><select id="crashTimingMode" class="glass-input text-xs"><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option><option value="early">åºç›¤</option><option value="late">çµ‚ç›¤</option></select></div>
                </div>
                <button onclick="rerollCrash()" class="w-full bg-slate-700 text-xs py-2 rounded mb-3">ğŸ² æš´è½ã‚·ãƒŠãƒªã‚ªå†æŠ½é¸</button>
                
                <h2 class="text-xs font-bold text-slate-300 mb-2 mt-4">DATA</h2>
                <button onclick="lockComparison()" class="w-full bg-indigo-600 text-white text-xs font-bold py-2 rounded mb-2">ğŸ“Œ ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒç”¨ã«å›ºå®š</button>
                <div class="flex gap-2">
                    <button onclick="exportSettings()" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">ä¿å­˜</button>
                    <button onclick="triggerImport()" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">èª­è¾¼</button>
                    <input type="file" id="importFile" style="display: none;" onchange="importSettings(this)">
                </div>
            </div>
        </div>

        <div class="result-column chart-area">
            <div id="achievementDesktop" class="hidden lg:block mb-6"></div>

            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[9px] text-gray-500 font-bold">SIMULATION CHART</span>
                <div class="flex gap-2">
                    <button onclick="downloadChart()" class="bg-slate-800 text-gray-300 px-2 py-1 rounded text-[10px]">ç”»åƒä¿å­˜</button>
                </div>
            </div>
            <div class="hidden lg:block glass-card p-2 mb-5 h-[350px] relative">
                <canvas id="chartCanvas"></canvas>
            </div>

            <div class="sub-charts-grid mb-5">
                <div class="glass-card p-4 text-center">
                    <p class="text-[10px] text-gray-400 font-bold mb-2">ASSET ALLOCATION <span id="chartLabelType" class="text-blue-400"></span></p>
                    <div class="h-[150px] flex justify-center"><canvas id="portfolioChart"></canvas></div>
                </div>
                <div class="glass-card p-4 text-center">
                    <p class="text-[10px] text-gray-400 font-bold mb-2">RISK SCENARIO <span id="riskLabelType" class="text-blue-400"></span></p>
                    <div class="h-[150px] flex justify-center"><canvas id="riskReturnChart"></canvas></div>
                </div>
            </div>

            <div class="sticky-result">
                <div class="max-w-md mx-auto lg:max-w-none grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[9px] text-gray-500 mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p><p class="text-xl font-black text-yellow-400"><span id="resPeakAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                    <div class="border-l border-slate-700"><p class="text-[9px] text-gray-500 mb-0.5">100æ­³æ™‚ç‚¹</p><p class="text-base font-bold text-gray-200"><span id="resEndAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chartModal"><div class="w-full max-w-lg flex justify-between items-center mb-4 px-2"><span class="text-[10px] text-gray-400 font-bold">FULL SCREEN CHART</span><button onclick="closeChartModal()" class="bg-red-500/20 text-red-400 px-4 py-1 rounded-full text-xs font-bold">âœ• é–‰ã˜ã‚‹</button></div><canvas id="modalChartCanvas"></canvas></div>

    <script>
        // ã€é‡è¦ã€‘ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã®åˆæœŸåŒ–å‡¦ç†
        try {
            if (typeof ChartDataLabels !== 'undefined') {
                Chart.unregister(ChartDataLabels);
            }
        } catch(e) { console.error("Plugin error", e); }

        const STORAGE_KEY = 'simulatorState_v12';
        const ASSETS = [
            { key: 'cash', name: 'ğŸ’´ ç¾é‡‘', color: '#64748b', ret: 0.00, crash: 1.00, defC: 50, defF: 0 },
            { key: 'bond', name: 'ğŸ“œ å‚µåˆ¸', color: '#2dd4bf', ret: 0.03, crash: 0.95, defC: 0, defF: 0 },
            { key: 'gold', name: 'ğŸ¥‡ é‡‘',   color: '#fbbf24', ret: 0.04, crash: 0.85, defC: 0, defF: 0 },
            { key: 'reit', name: 'ğŸ¢ ä¸å‹•ç”£', color: '#a855f7', ret: 0.045, crash: 0.75, defC: 0, defF: 0 },
            { key: 'orkan', name: 'ğŸ›¡ï¸ ã‚ªãƒ«ã‚«ãƒ³', color: '#10b981', ret: 0.05, crash: 0.75, defC: 50, defF: 50 },
            { key: 'sp500', name: 'âš”ï¸ S&P500', color: '#3b82f6', ret: 0.10, crash: 0.60, defC: 0, defF: 30 },
            { key: 'nasdaq', name: 'ğŸ’» NASDAQ', color: '#06b6d4', ret: 0.13, crash: 0.50, defC: 0, defF: 20 },
            { key: 'fang', name: 'ğŸ’ FANG+', color: '#f472b6', ret: 0.17, crash: 0.45, defC: 0, defF: 0 },
            { key: 'cyc', name: 'ğŸ”¥ æ™¯æ°—æ•æ„Ÿ', color: '#ef4444', ret: 0.15, crash: 0.45, defC: 0, defF: 0 },
            { key: 'def', name: 'ğŸ›¡ï¸ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³', color: '#84cc16', ret: 0.06, crash: 0.75, defC: 0, defF: 0 },
            { key: 'cryp', name: 'â‚¿ ä»®æƒ³é€šè²¨', color: '#8b5cf6', ret: 0.30, crash: 0.30, defC: 0, defF: 0 },
            { key: 'lev', name: 'ğŸš€ ãƒ¬ãƒãƒŠã‚¹', color: '#ec4899', ret: 0.25, crash: 0.25, defC: 0, defF: 0 }
        ];

        let activeTab = 'current';
        let inputMode = 'percent'; // 'percent' or 'amount'
        let myChart = null, myChartMobile = null, pfChart = null, rrChart = null, modalChart = null;
        let memoCrashYears = [], memoCrashKey = '', lockedData = null;
        let actualHistory = [];

        window.onload = () => {
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id.startsWith('amt_')) return; // amount inputs handled separately
                el.addEventListener(el.type==='range'?'input':'change', calculate);
            });
            
            renderSliders('current'); renderSliders('future');
            renderAmountInputs('current'); renderAmountInputs('future');
            loadState(); 
            setInputMode('percent'); // default
            calculate();
        };

        // --- Input Mode Switching ---
        function setInputMode(mode) {
            inputMode = mode;
            const isPct = mode === 'percent';
            
            // Toggle Buttons
            document.getElementById('btnModePercent').className = isPct ? "px-2 py-1 text-[10px] font-bold rounded text-white bg-blue-600" : "px-2 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white";
            document.getElementById('btnModeAmount').className = !isPct ? "px-2 py-1 text-[10px] font-bold rounded text-white bg-blue-600" : "px-2 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white";

            // Show/Hide Containers
            document.getElementById('uiPercentMode').classList.toggle('hidden', !isPct);
            document.getElementById('uiAmountMode').classList.toggle('hidden', isPct);

            // Sync Logic
            if(isPct) {
                // Switching TO Percent Mode: Calculate Percentages from Amounts
                syncAmountsToPercent();
                document.getElementById('initialAsset').disabled = false;
                document.getElementById('monthlyAdd').disabled = false;
            } else {
                // Switching TO Amount Mode: Calculate Amounts from Percentages
                syncPercentToAmounts();
                // In Amount Mode, Total Asset & Monthly Add are derived from sums
                if(activeTab === 'current') document.getElementById('initialAsset').disabled = true;
                if(activeTab === 'future') document.getElementById('monthlyAdd').disabled = true;
            }
        }

        function renderAmountInputs(type) {
            const container = document.getElementById(type === 'current' ? 'inputsCurrent' : 'inputsFuture');
            container.innerHTML = ASSETS.map(a => `
                <div>
                    <label class="text-[10px] text-gray-500 block mb-0.5" style="color:${a.color}">${a.name}</label>
                    <input type="number" id="amt_${type}_${a.key}" class="glass-input text-right text-sm" placeholder="0" oninput="onAmountInput('${type}')">
                </div>
            `).join('');
        }

        function onAmountInput(type) {
            // Calculate Total
            let total = 0;
            ASSETS.forEach(a => {
                total += Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0;
            });
            
            document.getElementById('amountModeTotal').innerText = total.toLocaleString();

            // Update Main Inputs based on Type
            if(type === 'current') {
                document.getElementById('initialAsset').value = total;
            } else {
                document.getElementById('monthlyAdd').value = total;
            }

            // Update Percent Sliders (Hidden but needed for calculation)
            if(total > 0) {
                ASSETS.forEach(a => {
                    const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0;
                    const pct = (val / total) * 100;
                    document.getElementById(`range_${type}_${a.key}`).value = pct;
                    document.getElementById(`num_${type}_${a.key}`).value = pct.toFixed(1);
                });
            } else {
                // If total is 0, reset weights
                ASSETS.forEach(a => {
                    document.getElementById(`range_${type}_${a.key}`).value = 0;
                    document.getElementById(`num_${type}_${a.key}`).value = 0;
                });
            }
            calculate();
        }

        function syncPercentToAmounts() {
            // Percent -> Amount
            const totalC = Number(document.getElementById('initialAsset').value) || 0;
            const totalF = Number(document.getElementById('monthlyAdd').value) || 0;
            
            // Normalize current weights
            let wC = 0; ASSETS.forEach(a => wC += Number(document.getElementById(`range_current_${a.key}`).value));
            // Normalize future weights
            let wF = 0; ASSETS.forEach(a => wF += Number(document.getElementById(`range_future_${a.key}`).value));

            ASSETS.forEach(a => {
                const pC = Number(document.getElementById(`range_current_${a.key}`).value);
                const amtC = wC > 0 ? (pC / wC) * totalC : 0;
                document.getElementById(`amt_current_${a.key}`).value = Math.round(amtC);

                const pF = Number(document.getElementById(`range_future_${a.key}`).value);
                const amtF = wF > 0 ? (pF / wF) * totalF : 0;
                document.getElementById(`amt_future_${a.key}`).value = Math.round(amtF);
            });
            
            // Update Display Total
            const t = activeTab === 'current' ? totalC : totalF;
            document.getElementById('amountModeTotal').innerText = t.toLocaleString();
        }

        function syncAmountsToPercent() {
            // Trigger logic similar to input change, but just recalculate weights once
            ['current', 'future'].forEach(type => {
                let total = 0;
                ASSETS.forEach(a => total += Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0);
                if(total > 0) {
                    ASSETS.forEach(a => {
                        const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0;
                        const pct = (val / total) * 100;
                        document.getElementById(`range_${type}_${a.key}`).value = pct;
                        document.getElementById(`num_${type}_${a.key}`).value = Math.round(pct);
                    });
                }
            });
        }

        // --- Core Simulation ---
        function calculate() {
            updateTotalBar(); saveState();
            const age = +document.getElementById('currentAge').value || 35;
            const init = (+document.getElementById('initialAsset').value || 0) * 10000;
            const monthly = (+document.getElementById('monthlyAdd').value) * 10000;
            const target = (+document.getElementById('targetAsset').value) * 10000;
            const wAge = +document.getElementById('withdrawAge').value || 60;
            const wRate = +document.getElementById('num_withdrawRate').value / 100;
            const crashCount = +document.getElementById('crashCount').value;
            
            // Calculate Weights (Always based on Sliders/Percent Inputs as they are synced)
            let retC=0, crashC=0, totalC=0, pfDataC=[];
            ASSETS.forEach(a => { const v = +document.getElementById(`range_current_${a.key}`).value||0; totalC += v; if(v>0) pfDataC.push({name:a.name, val:v, color:a.color}); });
            ASSETS.forEach(a => { if(totalC>0){ const w=+document.getElementById(`range_current_${a.key}`).value/totalC; retC+=a.ret*w; crashC+=a.crash*w; }});

            let retF=0, crashF=0, totalF=0, pfDataF=[];
            ASSETS.forEach(a => { const v = +document.getElementById(`range_future_${a.key}`).value||0; totalF += v; if(v>0) pfDataF.push({name:a.name, val:v, color:a.color}); });
            ASSETS.forEach(a => { if(totalF>0){ const w=+document.getElementById(`range_future_${a.key}`).value/totalF; retF+=a.ret*w; crashF+=a.crash*w; }});

            document.getElementById('tabRetCurrent').innerText = (retC*100).toFixed(1);
            document.getElementById('tabRiskCurrent').innerText = totalC>0 ? (-(1-crashC)*100).toFixed(1) : '0.0';
            document.getElementById('tabRetFuture').innerText = (retF*100).toFixed(1);
            document.getElementById('tabRiskFuture').innerText = totalF>0 ? (-(1-crashF)*100).toFixed(1) : '0.0';
            
            const expRet = ((retC+retF)/2*100).toFixed(1);
            const maxCrash = (-(1-(crashC+crashF)/2)*100).toFixed(1);
            document.getElementById('specTotalRet').innerText = expRet;
            document.getElementById('specTotalCrash').innerText = maxCrash;

            // Simulation Loop
            let hAge=[age], hPrin=[init/10000], hTotal=[init/10000], cA=init, cAcc=0, cP=init, peak=init, gAge=null, rAge=null;
            
            if(crashCount>0) {
                const key = `${age}-${crashCount}-${document.getElementById('crashTimingMode').value}`;
                if(memoCrashKey!==key || !memoCrashYears.length) {
                    let arr = Array.from({length:100-age},(_,i)=>i+1);
                    if(document.getElementById('crashTimingMode').value==='random') arr.sort(()=>Math.random()-0.5);
                    else if(document.getElementById('crashTimingMode').value==='early') arr=arr.map((_,i)=>(i+1)*2);
                    else arr=arr.reverse().map((_,i)=>(i+1)*2);
                    memoCrashYears = arr.slice(0, crashCount); memoCrashKey=key;
                }
            } else { memoCrashYears=[]; memoCrashKey=''; }

            for(let i=1; i<=100-age; i++){
                const isCr = memoCrashYears.includes(i);
                if((cA+cAcc)>=target && !rAge) rAge=age+i-1;
                if(document.getElementById('coastFireMode').checked && (cA+cAcc)>=target && !gAge) gAge=age+i-1;
                let add=0; if(age+i<wAge && !gAge) { add=monthly*12; cP+=add; }
                if(age+i<wAge) { cA*=isCr?crashC:(1+retC); cAcc=(cAcc+add)*(isCr?crashF:(1+retF)); }
                else {
                    let tot=cA+cAcc; let wAmt = tot * wRate;
                    if(tot>0){ let r=wAmt/tot; if(r>1)r=1; cP-=cP*r; }
                    tot=Math.max(0, tot-wAmt);
                    tot*=isCr?(cA*crashC+cAcc*crashF)/(cA+cAcc||1):(1+(cA*retC+cAcc*retF)/(cA+cAcc||1));
                    cA=tot*(cA/(cA+cAcc||1)); cAcc=tot-cA;
                }
                const now=cA+cAcc; peak=Math.max(peak,now); hAge.push(age+i); hPrin.push(Math.round(cP/10000)); hTotal.push(Math.round(now/10000));
            }

            document.getElementById('resPeakAsset').innerText = Math.round(peak/10000).toLocaleString();
            document.getElementById('resEndAsset').innerText = hTotal[hTotal.length-1].toLocaleString();
            renderAchievement(rAge);
            drawMainChart(hAge, hTotal, hPrin);

            if (activeTab === 'current') updateSubCharts((retC*100).toFixed(1), (-(1-crashC)*100).toFixed(1), pfDataC);
            else updateSubCharts((retF*100).toFixed(1), (-(1-crashF)*100).toFixed(1), pfDataF);
        }

        // --- Standard UI ---
        function renderSliders(type) {
            const el = document.getElementById(type === 'current' ? 'slidersCurrent' : 'slidersFuture');
            el.innerHTML = ASSETS.map(a => `
                <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-700/50">
                    <div class="flex justify-between mb-1"><span style="color:${a.color}" class="font-bold text-[10px]">${a.name}</span><input type="number" id="num_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" class="bg-slate-900 border border-slate-600 rounded w-10 text-right text-xs text-white" oninput="syncRange('range_${type}_${a.key}', this.value)"></div>
                    <input type="range" id="range_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" class="w-full" oninput="syncNum('num_${type}_${a.key}', this.value)">
                </div>`).join('');
        }
        function syncNum(id, v) { document.getElementById(id).value=v; calculate(); }
        function syncRange(id, v) { document.getElementById(id).value=Math.max(0,Math.min(100,v)); calculate(); }
        
        function switchTab(t) { 
            activeTab=t; 
            document.getElementById('containerSlidersCurrent').classList.toggle('hidden', t!=='current'); 
            document.getElementById('containerSlidersFuture').classList.toggle('hidden', t!=='future'); 
            document.getElementById('containerInputsCurrent').classList.toggle('hidden', t!=='current'); 
            document.getElementById('containerInputsFuture').classList.toggle('hidden', t!=='future'); 

            document.getElementById('tabCurrent').className=t==='current'?'flex-1 tab-btn tab-active':'flex-1 tab-btn tab-inactive'; 
            document.getElementById('tabFuture').className=t==='future'?'flex-1 tab-btn tab-active':'flex-1 tab-btn tab-inactive'; 
            const suffix = t === 'current' ? '(ä»Šã®è³‡ç”£)' : '(ç©ç«‹)';
            document.getElementById('chartLabelType').innerText = suffix;
            document.getElementById('riskLabelType').innerText = suffix;
            
            // Re-calculate inputs if in Amount Mode
            if(inputMode === 'amount') {
                document.getElementById('initialAsset').disabled = t === 'current';
                document.getElementById('monthlyAdd').disabled = t === 'future';
                syncPercentToAmounts();
            }
            updateTotalBar(); calculate(); 
        }

        function updateTotalBar() { let t=0; ASSETS.forEach(a=>t+=parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value)||0); document.getElementById('totalProgressBar').style.width=Math.min(t,100)+'%'; }
        function applyPreset(t) { 
            if(inputMode === 'amount') { alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ï¼…æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ä½¿ç”¨ã§ãã¾ã™'); return; }
            let c={}; if(t==='defensive')c={cash:20,bond:30,gold:20,orkan:30}; else if(t==='standard')c={orkan:40,sp500:60}; else if(t==='aggressive')c={nasdaq:30,fang:20,cyc:20,cryp:10,lev:20}; 
            ASSETS.forEach(a=>{ let v=c[a.key]||0; document.getElementById(`range_${activeTab}_${a.key}`).value=v; document.getElementById(`num_${activeTab}_${a.key}`).value=v; }); 
            calculate(); 
        }

        // --- Charts ---
        function drawMainChart(labels, dTotal, dPrin) {
            if(!document.getElementById('chartCanvas')) return;
            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label:'è³‡ç”£ç·é¡', data:dTotal, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.3)', fill:true, pointRadius:0, borderWidth:2, order:0 },
                        { label:'å…ƒæœ¬', data:dPrin, borderColor:'#64748b', backgroundColor:'rgba(15,23,42,0.9)', fill:true, pointRadius:0, borderWidth:1, order:1 },
                        { label:'æ¯”è¼ƒ', data:lockedData || [], borderColor:'rgba(255,255,255,0.5)', borderDash:[5,5], pointRadius:0, fill:false, order:2, hidden:!lockedData }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ legend:{labels:{color:'#94a3b8'}}, datalabels: { display: false } }, 
                    scales:{x:{grid:{display:false},ticks:{color:'#64748b'}}, y:{stacked:false, grid:{color:'#1e293b'},ticks:{color:'#64748b'}}}, 
                    interaction:{mode:'index',intersect:false} 
                }
            };
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, config);
            const ctxMob = document.getElementById('chartCanvasMobile').getContext('2d');
            if(myChartMobile) myChartMobile.destroy();
            myChartMobile = new Chart(ctxMob, JSON.parse(JSON.stringify(config)));
        }

        function updateSubCharts(retVal, crashVal, pfData) {
            const ctxPf = document.getElementById('portfolioChart').getContext('2d');
            const ctxRr = document.getElementById('riskReturnChart').getContext('2d');
            
            if(pfChart) pfChart.destroy();
            pfChart = new Chart(ctxPf, {
                type: 'doughnut',
                plugins: [ChartDataLabels], 
                data: { 
                    labels: pfData.map(d=>d.name), 
                    datasets: [{ data: pfData.map(d=>d.val), backgroundColor: pfData.map(d=>d.color), borderWidth:0 }] 
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + Math.round(val) + '%', anchor: 'center', align: 'center' } }, 
                    cutout:'50%' 
                }
            });
            
            if(rrChart) rrChart.destroy();
            rrChart = new Chart(ctxRr, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: ['æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³', 'æœ€å¤§ãƒªã‚¹ã‚¯'],
                    datasets: [{ data: [parseFloat(retVal), parseFloat(crashVal)], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 4 }]
                },
                options: {
                    responsive:true, maintainAspectRatio:false, layout: { padding: { top: 40 } }, indexAxis: 'x',
                    plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (val) => val > 0 ? '+' + val + '%' : val + '%', anchor: 'end', align: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0 ? 'top' : 'bottom' } }, 
                    scales:{ x:{ grid:{display:false}, ticks:{color:'#94a3b8', font:{size:10}} }, y:{ grid:{color:'#334155'}, ticks:{color:'#64748b'}, beginAtZero:true } } 
                }
            });
        }

        function lockComparison() { if(myChart) { lockedData = [...myChart.data.datasets[0].data]; alert('å›ºå®šã—ã¾ã—ãŸ'); calculate(); } }
        function renderAchievement(age) { document.getElementById('achievementMobile').innerHTML = age ? `<div class="bg-yellow-600/80 p-2 rounded text-white font-bold mb-2">ğŸ‰ ${age}æ­³ã§é”æˆï¼</div>` : `<div class="bg-slate-800 p-2 rounded text-gray-400 mb-2">æœªé”...</div>`; document.getElementById('achievementDesktop').innerHTML = document.getElementById('achievementMobile').innerHTML; }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ currentAge:document.getElementById('currentAge').value })); } 
        function loadState() { try { const s=JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){} }
        function exportSettings() { const s=localStorage.getItem(STORAGE_KEY); if(s){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([s],{type:'application/json'})); a.download='fire_sim_data.json'; a.click(); } }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importSettings(e) { const r=new FileReader(); r.onload=function(e){localStorage.setItem(STORAGE_KEY,e.target.result); loadState(); calculate(); alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');}; r.readAsText(e.files[0]); }
        function downloadChart() { const a=document.createElement('a'); a.href=document.getElementById('chartCanvas').toDataURL(); a.download='chart.png'; a.click(); }
        function rerollCrash() { memoCrashYears=[]; calculate(); }
        function closeChartModal() { document.getElementById('chartModal').style.display='none'; }
    </script>
</body>
</html>
