<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Simulator v47.0 - Split Scroll Fixed</title>
    <!-- Chart.js æœ¬ä½“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ« -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #0b0f19; 
            color: #e2e8f0; 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 20%); 
            background-attachment: fixed; 
            margin: 0;
            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ */
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; border-radius: 8px; width: 100%; padding: 8px; font-weight: bold; text-align: center; }
        .glass-input:disabled { background: rgba(15, 23, 42, 0.3); color: #64748b; border-color: transparent; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .config-modal-content { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 20px; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: rgba(148, 163, 184, 0.2); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #60a5fa; margin-top: -6px; border: 2px solid #1e293b; }
        
        .tab-btn { transition: all 0.3s; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; text-align: center; }
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .tab-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; border: 1px solid rgba(255,255,255,0.05); }
        
        header { padding: 1rem 2rem; flex: 0 0 auto; }

        /* --- PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (å·¦å³ç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) --- */
        @media (min-width: 1024px) {
            body {
                height: 100vh;
                overflow: hidden; /* ç”»é¢å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
                display: flex;
                flex-direction: column;
            }

            .container-grid { 
                display: grid; 
                grid-template-columns: 500px 1fr; /* å·¦500pxå›ºå®š */
                gap: 40px; 
                padding: 0 40px 0 40px; 
                max-width: 1600px; 
                margin: 0 auto;
                height: 100%; /* æ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
                overflow: hidden; /* ã¯ã¿å‡ºã—ç¦æ­¢ */
                align-items: start;
            }

            .input-column {
                height: 100%;
                overflow-y: auto; /* å·¦å´ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
                padding-right: 10px;
                padding-bottom: 100px; /* ä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ä½™ç™½ */
            }

            .result-column {
                height: 100%;
                overflow-y: auto; /* å³å´ã‚‚ä¸­èº«ãŒå¤šã„å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
                display: flex;
                flex-direction: column;
                gap: 30px; 
                padding-right: 10px;
                padding-bottom: 100px;
            }
        }

        /* --- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        @media (max-width: 1023px) {
            body { height: auto; overflow-y: auto; display: block; }
            .container-grid { display: block; padding: 16px; height: auto; }
            .input-column { height: auto; margin-bottom: 40px; overflow: visible; }
            .result-column { display: none; } /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å³ã‚«ãƒ©ãƒ ã‚’éè¡¨ç¤º */
            .mobile-chart-only { display: block; margin-bottom: 30px; }
            .pc-only { display: none !important; }
        }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢è¨­å®š */
        .main-chart-container { 
            position: relative; 
            width: 100%; 
            height: 450px; /* å›ºå®šé«˜ã• */
            width: 100%;
            margin: 0;
            flex-shrink: 0;
        }

        .sub-charts-container { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: 320px; 
            width: 100%;
            margin: 0;
            flex-shrink: 0;
        }
        
        .sub-charts-container .glass-card {
            height: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        
        .chart-inner-wrapper {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            padding-top: 20px; 
        }

        .result-summary-card { 
            width: 100%;
            margin: 0;
            padding: 24px;
            flex-shrink: 0;
        }

        .mobile-chart-only { display: none; }
        @media (max-width: 1023px) {
            .mobile-chart-only { display: block; }
            .sub-charts-container { grid-template-columns: 1fr; height: auto; }
            .sub-charts-container .glass-card { height: 280px; margin-bottom: 0; }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.5); border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">FIRE Simulator <span class="text-xs text-gray-500 ml-1">v47.0</span></h1>
    </header>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒˆãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
    <div class="lg:hidden p-4 mobile-chart-only">
        <div class="glass-card p-2 h-[280px] relative mb-4">
            <canvas id="chartCanvasMobile"></canvas>
        </div>
        <div class="glass-card p-4">
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-[9px] text-gray-500 mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p>
                    <p class="text-2xl font-black text-yellow-400">
                        <span id="resPeakAssetMobile">0</span><span class="text-xs ml-1">ä¸‡</span>
                    </p>
                </div>
                <div class="border-l border-slate-700">
                    <p class="text-[9px] text-gray-500 mb-0.5">100æ­³æ™‚ç‚¹</p>
                    <p class="text-xl font-bold text-gray-200">
                        <span id="resEndAssetMobile">0</span><span class="text-xs ml-1">ä¸‡</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container-grid">
        <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå…¥åŠ› (ç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) -->
        <div class="input-column">
            <div id="achievementMobile" class="lg:hidden mb-4"></div>

            <div class="glass-card p-4 mb-5">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-blue-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-blue-300">PROFILE</h2></div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="currentAge" value="35" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨è³‡ç”£ (ä¸‡)</label><input type="number" id="initialAsset" value="1000" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">æ¯æœˆç©ç«‹ (ä¸‡)</label><input type="number" id="monthlyAdd" value="10" class="glass-input"></div>
                    <div><label class="text-[10px] text-yellow-500 block mb-1">ç›®æ¨™é‡‘é¡ (ä¸‡)</label><input type="number" id="targetAsset" value="3000" class="glass-input border-yellow-500/30 text-yellow-100"></div>
                </div>
                <div class="bg-blue-900/20 p-2 rounded-lg flex items-center gap-2">
                    <input type="checkbox" id="coastFireMode" class="w-4 h-4" onchange="calculate(false)"><label for="coastFireMode" class="text-[10px] font-bold text-blue-200 cursor-pointer">ç›®æ¨™é”æˆã§ç©ç«‹åœæ­¢</label>
                </div>
                <div id="graduationAgeArea" class="hidden mt-2 text-center"><span class="bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded text-[10px] font-bold">ğŸ‰ <span id="graduationAge">0</span>æ­³ã§å’æ¥­</span></div>
            </div>

            <div class="glass-card p-4 mb-5">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center"><div class="w-1 h-4 bg-purple-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-purple-300">PORTFOLIO</h2></div>
                    <button onclick="openConfigModal()" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-gray-300 px-2 py-1 rounded flex items-center gap-1">âš™ è¡¨ç¤ºé …ç›®è¨­å®š</button>
                </div>

                <div class="flex justify-between items-center mb-4 bg-slate-900/50 p-1 rounded-lg">
                    <button onclick="setInputMode('percent')" id="btnModePercent" class="flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600">ï¼…æŒ‡å®šãƒ¢ãƒ¼ãƒ‰</button>
                    <button onclick="setInputMode('amount')" id="btnModeAmount" class="flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white">é‡‘é¡æŒ‡å®šãƒ¢ãƒ¼ãƒ‰</button>
                </div>

                <div class="flex gap-2 mb-4">
                    <div id="tabCurrent" onclick="switchTab('current')" class="flex-1 tab-btn tab-active">ä»Šã®è³‡ç”£</div>
                    <div id="tabFuture" onclick="switchTab('future')" class="flex-1 tab-btn tab-inactive">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</div>
                </div>

                <div id="uiPercentMode">
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <button onclick="applyPreset('defensive')" class="bg-emerald-900/30 text-emerald-400 text-[10px] py-2 rounded">ğŸ›¡ï¸ é‰„å£</button>
                        <button onclick="applyPreset('standard')" class="bg-blue-900/30 text-blue-400 text-[10px] py-2 rounded">ğŸ‘‘ ç‹é“</button>
                        <button onclick="applyPreset('aggressive')" class="bg-purple-900/30 text-purple-400 text-[10px] py-2 rounded">ğŸš€ çˆ†ç›Š</button>
                    </div>
                    <div class="mb-5 bg-slate-800 rounded-full h-2 overflow-hidden"><div id="totalProgressBar" class="h-full bg-blue-500 transition-all" style="width: 100%"></div></div>
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒŠ: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                    <div id="containerSlidersCurrent" class="block"><div id="slidersCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerSlidersFuture" class="hidden"><div id="slidersFuture" class="grid grid-cols-2 gap-3"></div></div>
                </div>

                <div id="uiAmountMode" class="hidden">
                    <p class="text-[10px] text-yellow-500 mb-2 text-center bg-yellow-900/20 py-1 rounded">å„è³‡ç”£ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒŠ: é‡‘é¡å…¥åŠ› -->
                    <div id="containerInputsCurrent" class="block"><div id="inputsCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerInputsFuture" class="hidden"><div id="inputsFuture" class="grid grid-cols-2 gap-3"></div></div>
                    
                    <div class="mt-4 text-center border-t border-slate-700/50 pt-3">
                        <p class="text-[10px] text-gray-400">å…¥åŠ›åˆè¨ˆ</p>
                        <p class="text-xl font-black text-white"><span id="amountModeTotal">0</span> <span class="text-xs">ä¸‡å††</span></p>
                    </div>
                </div>
                
                <div class="mt-5 pt-4 border-t border-slate-700/50 grid grid-cols-2 gap-3 text-center">
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold mb-1">ç¾åœ¨ã®PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-blue-400"><span id="tabRetCurrent">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskCurrent">0.0</span>%</span></div>
                    </div>
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold">ç©ç«‹PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-green-400"><span id="tabRetFuture">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskFuture">0.0</span>%</span></div>
                    </div>
                </div>
            </div>

            <div class="mb-5 glass-card p-4">
                <p class="text-[10px] text-gray-400 mb-2 text-center font-bold">ASSET SPEC (10 YEARS)</p>
                <div class="flex justify-center gap-8 text-center">
                    <div><p class="text-[9px] text-gray-500">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</p><p class="text-2xl font-black text-white"><span id="specTotalRet">0.0</span>%</p></div>
                    <div><p class="text-[9px] text-gray-500">æœ€å¤§ãƒªã‚¹ã‚¯</p><p class="text-2xl font-black text-red-500"><span id="specTotalCrash">0.0</span>%</p></div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-indigo-500/20">
                <h2 class="text-xs font-bold text-indigo-300 mb-3">EXIT & CRASH</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawAge" value="60" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400">æš´è½è¨­å®š</label><select id="crashCount" class="glass-input text-xs"><option value="0">ãªã—</option><option value="2">2å›</option><option value="5" selected>5å›</option><option value="8">8å›</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">å–å´©ç‡(%)</label><input type="number" id="num_withdrawRate" value="4.0" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400">æš´è½æ™‚æœŸ</label><select id="crashTimingMode" class="glass-input text-xs"><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option><option value="early">åºç›¤</option><option value="late">çµ‚ç›¤</option></select></div>
                </div>
                <button onclick="rerollCrash()" class="w-full bg-slate-700 text-xs py-2 rounded mb-3">ğŸ² æš´è½ã‚·ãƒŠãƒªã‚ªå†æŠ½é¸</button>
                
                <h2 class="text-xs font-bold text-slate-300 mb-2 mt-4">DATA</h2>
                <button onclick="lockComparison()" class="w-full bg-indigo-600 text-white text-xs font-bold py-2 rounded mb-2">ğŸ“Œ ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒç”¨ã«å›ºå®š</button>
                <div class="flex gap-2">
                    <button onclick="exportSettings()" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">ä¿å­˜</button>
                    <button onclick="triggerImport()" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">èª­è¾¼</button>
                    <input type="file" id="importFile" style="display: none;" onchange="importSettings(this)">
                </div>
            </div>
            
            <div class="space-y-3 mb-10 text-center">
                <a href="#" class="block bg-gradient-to-r from-blue-700 to-blue-600 p-3 rounded-lg text-white font-bold text-xs">SBIè¨¼åˆ¸ å£åº§é–‹è¨­ (PR)</a>
                <a href="#" class="block bg-gradient-to-r from-emerald-700 to-emerald-600 p-3 rounded-lg text-white font-bold text-xs">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ (PR)</a>
            </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ ï¼šçµæœãƒ»ã‚°ãƒ©ãƒ• (PCç”¨: ç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) -->
        <div class="result-column pc-only">
            <div id="achievementDesktop" class="header-area hidden lg:block mb-4"></div>

            <div class="flex justify-between items-center px-1">
                <span class="text-[9px] text-gray-500 font-bold">SIMULATION CHART</span>
                <div class="flex gap-2">
                    <button onclick="resetChartZoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-[10px] font-bold flex items-center gap-1">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button onclick="downloadChart()" class="bg-slate-800 text-gray-300 px-2 py-1 rounded text-[10px]">ç”»åƒä¿å­˜</button>
                </div>
            </div>
            
            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="glass-card p-2 main-chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>

            <!-- ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ (é«˜ã•320pxã«æ‹¡å¼µ) -->
            <div class="sub-charts-container">
                <div class="glass-card p-2 text-center relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 absolute top-2 left-0 w-full z-10">ASSET ALLOCATION <span id="chartLabelType" class="text-blue-400"></span></p>
                    <div class="chart-inner-wrapper">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-2 text-center relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 absolute top-2 left-0 w-full z-10">RISK SCENARIO <span id="riskLabelType" class="text-blue-400"></span></p>
                    <div class="chart-inner-wrapper">
                        <canvas id="riskReturnChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- çµæœè¦ç´„ (PCç”¨) -->
            <div class="result-summary-card glass-card p-4">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[9px] text-gray-500 mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p><p class="text-2xl font-black text-yellow-400"><span id="resPeakAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                    <div class="border-l border-slate-700"><p class="text-[9px] text-gray-500 mb-0.5">100æ­³æ™‚ç‚¹</p><p class="text-xl font-bold text-gray-200"><span id="resEndAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal-overlay">
        <div class="config-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">è¡¨ç¤ºé …ç›®ã®é¸æŠ</h3>
                <button onclick="closeConfigModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <p class="text-xs text-gray-500 mb-4">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸè³‡ç”£ã¯å…¥åŠ›æ¬„ã¨ã‚°ãƒ©ãƒ•ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚</p>
            <div id="assetConfigList" class="space-y-2 mb-4"></div>
            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <script>
        try { if (typeof ChartDataLabels !== 'undefined') Chart.unregister(ChartDataLabels); } catch(e) {}

        const STORAGE_KEY = 'simulatorState_v47';
        const CONFIG_KEY = 'simulatorConfig_v47';
        
        const ASSETS_DEF = [
            { key: 'cash', name: 'ğŸ’´ ç¾é‡‘', desc: 'æ—¥æœ¬å††ã€‚æš´è½æ™‚ã®ã‚¯ãƒƒã‚·ãƒ§ãƒ³', color: '#64748b', ret: 0.00, crash: 1.00, defC: 50, defF: 0 },
            { key: 'bond', name: 'ğŸ“œ å‚µåˆ¸', desc: 'ç±³å›½å‚µç­‰ã€‚æ ªã¨é€†ã®å‹•ã', color: '#2dd4bf', ret: 0.03, crash: 0.95, defC: 0, defF: 0 },
            { key: 'gold', name: 'ğŸ¥‡ é‡‘',   desc: 'æœ‰äº‹ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬ã«å¼·ã„', color: '#fbbf24', ret: 0.04, crash: 0.85, defC: 0, defF: 0 },
            { key: 'reit', name: 'ğŸ¢ ä¸å‹•ç”£', desc: 'å®¶è³ƒåå…¥ã€‚ãƒŸãƒ‰ãƒ«ãƒªã‚¹ã‚¯', color: '#a855f7', ret: 0.045, crash: 0.75, defC: 0, defF: 0 },
            { key: 'orkan', name: 'ğŸ›¡ï¸ ã‚ªãƒ«ã‚«ãƒ³', desc: 'å…¨ä¸–ç•Œåˆ†æ•£ã€‚ç‹é“ã®æŠ•è³‡å…ˆ', color: '#10b981', ret: 0.05, crash: 0.75, defC: 50, defF: 50 },
            { key: 'sp500', name: 'âš”ï¸ S&P500', desc: 'ç±³å›½ä¸»è¦500ç¤¾ã«æŠ•è³‡', color: '#3b82f6', ret: 0.10, crash: 0.60, defC: 0, defF: 30 },
            { key: 'nasdaq', name: 'ğŸ’» NASDAQ100', desc: 'ç±³å›½ã®ãƒã‚¤ãƒ†ã‚¯ä¸­å¿ƒ100ç¤¾', color: '#06b6d4', ret: 0.13, crash: 0.50, defC: 0, defF: 20 },
            { key: 'fang', name: 'ğŸ’ FANG+', desc: 'å·¨å¤§ITä¼æ¥­10ç¤¾ã«é›†ä¸­', color: '#f472b6', ret: 0.17, crash: 0.45, defC: 0, defF: 0 },
            { key: 'cyc', name: 'ğŸ”¥ æ™¯æ°—æ•æ„Ÿæ ª', desc: 'é‡‘è/ç´ æã€‚æ™¯æ°—ã§å¤‰å‹•å¤§', color: '#ef4444', ret: 0.15, crash: 0.45, defC: 0, defF: 0 },
            { key: 'def', name: 'ğŸ›¡ï¸ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹æ ª', desc: 'ç”Ÿæ´»å¿…éœ€å“/ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢', color: '#84cc16', ret: 0.06, crash: 0.75, defC: 0, defF: 0 },
            { key: 'cryp', name: 'â‚¿ ä»®æƒ³é€šè²¨', desc: 'BTCç­‰ã€‚è¶…ãƒã‚¤ãƒªã‚¹ã‚¯', color: '#8b5cf6', ret: 0.30, crash: 0.30, defC: 0, defF: 0 },
            { key: 'lev', name: 'ğŸš€ ãƒ¬ãƒãƒŠã‚¹', desc: 'NASDAQã®2å€ã®å€¤å‹•ã', color: '#ec4899', ret: 0.25, crash: 0.25, defC: 0, defF: 0 }
        ];

        let activeTab = 'current';
        let inputMode = 'percent'; 
        let visibleAssets = {}; 
        let myChart = null, myChartMobile = null, pfChart = null, rrChart = null;
        let memoCrashYears = [], memoCrashKey = '', lockedData = null;
        let graduationIndex = null; 

        window.onload = () => {
            loadConfig();
            renderUI();
            
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id.startsWith('amt_')) return;
                if(el.type === 'checkbox' && el.id !== 'coastFireMode') return; 
                if(el.type !== 'checkbox') el.addEventListener(el.type==='range'?'input':'change', () => calculate(false));
            });
            
            loadState();
            setInputMode('percent');
            lockedData = null; 
            calculate(false);
        };

        function loadConfig() {
            try {
                const s = JSON.parse(localStorage.getItem(CONFIG_KEY));
                if (s) visibleAssets = s;
                else ASSETS_DEF.forEach(a => visibleAssets[a.key] = true);
            } catch(e) { ASSETS_DEF.forEach(a => visibleAssets[a.key] = true); }
        }

        function getActiveAssets() { return ASSETS_DEF.filter(a => visibleAssets[a.key] !== false); }

        function renderUI() {
            const assets = getActiveAssets();
            ['current', 'future'].forEach(type => {
                document.getElementById(`sliders${type.charAt(0).toUpperCase()+type.slice(1)}`).innerHTML = assets.map(a => `
                    <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-700/50">
                        <div class="flex justify-between mb-0.5"><span style="color:${a.color}" class="font-bold text-[10px]">${a.name}</span><input type="number" id="num_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" class="bg-slate-900 border border-slate-600 rounded w-10 text-right text-xs text-white" oninput="syncRange('range_${type}_${a.key}', this.value)"></div>
                        <div class="text-[8px] text-gray-500 mb-1">${a.desc}</div>
                        <input type="range" id="range_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" class="w-full" oninput="syncNum('num_${type}_${a.key}', this.value)">
                    </div>`).join('');
                document.getElementById(`inputs${type.charAt(0).toUpperCase()+type.slice(1)}`).innerHTML = assets.map(a => `
                    <div class="bg-slate-800/20 p-1.5 rounded">
                        <label class="text-[10px] font-bold block mb-0.5" style="color:${a.color}">${a.name}</label>
                        <div class="text-[8px] text-gray-500 mb-1">${a.desc}</div>
                        <input type="number" id="amt_${type}_${a.key}" class="glass-input text-right text-sm" placeholder="0" oninput="onAmountInput('${type}')">
                    </div>`).join('');
            });
            document.getElementById('assetConfigList').innerHTML = ASSETS_DEF.map(a => `
                <div class="flex items-center justify-between bg-slate-800 p-2 rounded">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background:${a.color}"></div><span class="text-sm font-bold text-gray-300">${a.name}</span></div>
                    <input type="checkbox" class="w-5 h-5" id="cfg_${a.key}" ${visibleAssets[a.key]!==false?'checked':''}>
                </div>`).join('');
        }

        function openConfigModal() { document.getElementById('configModal').style.display = 'flex'; }
        function closeConfigModal() { document.getElementById('configModal').style.display = 'none'; }
        function saveConfig() {
            ASSETS_DEF.forEach(a => visibleAssets[a.key] = document.getElementById(`cfg_${a.key}`).checked);
            localStorage.setItem(CONFIG_KEY, JSON.stringify(visibleAssets));
            renderUI(); closeConfigModal(); setInputMode(inputMode); calculate(false);
        }

        function resetChartZoom() { if(myChart) myChart.resetZoom(); }

        function setInputMode(mode) {
            inputMode = mode;
            const isPct = mode === 'percent';
            document.getElementById('btnModePercent').className = isPct ? "flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600 transition-colors" : "flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition-colors";
            document.getElementById('btnModeAmount').className = !isPct ? "flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600 transition-colors" : "flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition-colors";
            document.getElementById('uiPercentMode').classList.toggle('hidden', !isPct);
            document.getElementById('uiAmountMode').classList.toggle('hidden', isPct);
            if(isPct) { syncAmountsToPercent(); document.getElementById('initialAsset').disabled = false; document.getElementById('monthlyAdd').disabled = false; } 
            else { syncPercentToAmounts(); if(activeTab === 'current') document.getElementById('initialAsset').disabled = true; if(activeTab === 'future') document.getElementById('monthlyAdd').disabled = true; }
        }

        function onAmountInput(type) {
            const assets = getActiveAssets();
            let total = 0;
            assets.forEach(a => { const el = document.getElementById(`amt_${type}_${a.key}`); if(el) total += Number(el.value) || 0; });
            document.getElementById('amountModeTotal').innerText = total.toLocaleString();
            if(type === 'current') document.getElementById('initialAsset').value = total; else document.getElementById('monthlyAdd').value = total;
            if(total > 0) assets.forEach(a => { const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0; const pct = (val / total) * 100; const rng = document.getElementById(`range_${type}_${a.key}`); const num = document.getElementById(`num_${type}_${a.key}`); if(rng) rng.value = pct; if(num) num.value = pct.toFixed(1); });
            calculate(false);
        }

        function syncPercentToAmounts() {
            const assets = getActiveAssets();
            const totalC = Number(document.getElementById('initialAsset').value) || 0;
            const totalF = Number(document.getElementById('monthlyAdd').value) || 0;
            let wC = 0, wF = 0;
            assets.forEach(a => { wC += Number(document.getElementById(`range_current_${a.key}`).value)||0; wF += Number(document.getElementById(`range_future_${a.key}`).value)||0; });
            assets.forEach(a => {
                const pC = Number(document.getElementById(`range_current_${a.key}`).value)||0;
                document.getElementById(`amt_current_${a.key}`).value = Math.round(wC > 0 ? (pC / wC) * totalC : 0);
                const pF = Number(document.getElementById(`range_future_${a.key}`).value)||0;
                document.getElementById(`amt_future_${a.key}`).value = Math.round(wF > 0 ? (pF / wF) * totalF : 0);
            });
            document.getElementById('amountModeTotal').innerText = (activeTab === 'current' ? totalC : totalF).toLocaleString();
        }

        function syncAmountsToPercent() {
            ['current', 'future'].forEach(type => {
                const assets = getActiveAssets();
                let total = 0;
                assets.forEach(a => total += Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0);
                if(total > 0) assets.forEach(a => { const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0; const pct = (val / total) * 100; const rng = document.getElementById(`range_${type}_${a.key}`); const num = document.getElementById(`num_${type}_${a.key}`); if(rng) rng.value = pct; if(num) num.value = pct.toFixed(1); });
            });
        }

        function syncNum(id, v) { document.getElementById(id).value=v; calculate(false); }
        function syncRange(id, v) { document.getElementById(id).value=Math.max(0,Math.min(100,v)); calculate(false); }

        function updateTotalBar() { 
            let t=0; getActiveAssets().forEach(a=>t+=parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value)||0); 
            const bar = document.getElementById('totalProgressBar');
            if(bar) bar.style.width=Math.min(t,100)+'%'; 
        }

        function calculate(skipMainChart = false) {
            updateTotalBar(); saveState();
            const assets = getActiveAssets();
            const age = +document.getElementById('currentAge').value || 35;
            const init = (+document.getElementById('initialAsset').value || 0) * 10000;
            const monthly = (+document.getElementById('monthlyAdd').value) * 10000;
            const target = (+document.getElementById('targetAsset').value) * 10000;
            const wAge = +document.getElementById('withdrawAge').value || 60;
            const wRate = +document.getElementById('num_withdrawRate').value / 100;
            const crashCount = +document.getElementById('crashCount').value;
            
            let retC=0, crashC=0, totalC=0, pfDataC=[];
            assets.forEach(a => { const v = +document.getElementById(`range_current_${a.key}`).value||0; totalC += v; if(v>0) pfDataC.push({name:a.name, val:v, color:a.color}); });
            assets.forEach(a => { if(totalC>0){ const w=+document.getElementById(`range_current_${a.key}`).value/totalC; retC+=a.ret*w; crashC+=a.crash*w; }});
            let retF=0, crashF=0, totalF=0, pfDataF=[];
            assets.forEach(a => { const v = +document.getElementById(`range_future_${a.key}`).value||0; totalF += v; if(v>0) pfDataF.push({name:a.name, val:v, color:a.color}); });
            assets.forEach(a => { if(totalF>0){ const w=+document.getElementById(`range_future_${a.key}`).value/totalF; retF+=a.ret*w; crashF+=a.crash*w; }});

            document.getElementById('tabRetCurrent').innerText = (retC*100).toFixed(1);
            document.getElementById('tabRiskCurrent').innerText = totalC>0 ? (-(1-crashC)*100).toFixed(1) : '0.0';
            document.getElementById('tabRetFuture').innerText = (retF*100).toFixed(1);
            document.getElementById('tabRiskFuture').innerText = totalF>0 ? (-(1-crashF)*100).toFixed(1) : '0.0';
            document.getElementById('specTotalRet').innerText = ((retC+retF)/2*100).toFixed(1);
            document.getElementById('specTotalCrash').innerText = (-(1-(crashC+crashF)/2)*100).toFixed(1);

            let hAge=[age], hPrin=[init/10000], hTotal=[init/10000], cA=init, cAcc=0, cP=init, peak=init, gAge=null, rAge=null;
            graduationIndex = null; 

            // Check if initially achieved
            if (init >= target) {
                rAge = age;
                graduationIndex = 0;
            }

            if(crashCount>0) {
                const key = `${age}-${crashCount}-${document.getElementById('crashTimingMode').value}`;
                if(memoCrashKey!==key || !memoCrashYears.length) {
                    let arr = Array.from({length:100-age},(_,i)=>i+1);
                    if(document.getElementById('crashTimingMode').value==='random') arr.sort(()=>Math.random()-0.5);
                    else if(document.getElementById('crashTimingMode').value==='early') arr=arr.map((_,i)=>(i+1)*2);
                    else arr=arr.reverse().map((_,i)=>(i+1)*2);
                    memoCrashYears = arr.slice(0, crashCount); memoCrashKey=key;
                }
            } else { memoCrashYears=[]; memoCrashKey=''; }

            for(let i=1; i<=100-age; i++){
                const isCr = memoCrashYears.includes(i);
                
                let add = 0;
                if(age+i < wAge) {
                    if(!document.getElementById('coastFireMode').checked) {
                        add = monthly * 12;
                    } else if (!gAge) {
                        add = monthly * 12;
                    }
                }
                
                cP += add;

                if(age+i < wAge) { 
                    cA *= isCr ? crashC : (1+retC); 
                    cAcc = (cAcc + add) * (isCr ? crashF : (1+retF)); 
                } else {
                    let tot = cA + cAcc; 
                    let wAmt = tot * wRate;
                    if(tot>0){ let r=wAmt/tot; if(r>1)r=1; cP-=cP*r; }
                    tot = Math.max(0, tot - wAmt);
                    let blendedRet = (cA*retC + cAcc*retF) / (cA+cAcc||1);
                    let blendedCrash = (cA*crashC + cAcc*crashF) / (cA+cAcc||1);
                    tot *= isCr ? blendedCrash : (1+blendedRet);
                    cA = tot * (cA/(cA+cAcc||1)); 
                    cAcc = tot - cA;
                }

                const now = cA + cAcc; 
                peak = Math.max(peak, now); 
                hAge.push(age+i); 
                hPrin.push(Math.round(cP/10000)); 
                hTotal.push(Math.round(now/10000));

                if(now >= target && !rAge) {
                    rAge = age + i;
                    graduationIndex = i; 
                }
                if(document.getElementById('coastFireMode').checked && now >= target && !gAge) {
                    gAge = age + i;
                }
            }

            // PCç”¨æ›´æ–°
            document.getElementById('resPeakAsset').innerText = Math.round(peak/10000).toLocaleString();
            document.getElementById('resEndAsset').innerText = hTotal[hTotal.length-1].toLocaleString();
            
            // ãƒ¢ãƒã‚¤ãƒ«ç”¨æ›´æ–°
            if(document.getElementById('resPeakAssetMobile')) {
                document.getElementById('resPeakAssetMobile').innerText = Math.round(peak/10000).toLocaleString();
            }
            if(document.getElementById('resEndAssetMobile')) {
                document.getElementById('resEndAssetMobile').innerText = hTotal[hTotal.length-1].toLocaleString();
            }

            renderAchievement(rAge);
            
            if (!skipMainChart) {
                drawMainChart(hAge, hTotal, hPrin);
            }

            if (activeTab === 'current') updateSubCharts((retC*100).toFixed(1), (-(1-crashC)*100).toFixed(1), pfDataC);
            else updateSubCharts((retF*100).toFixed(1), (-(1-crashF)*100).toFixed(1), pfDataF);
        }

        function switchTab(t) { 
            activeTab=t; 
            document.getElementById('containerSlidersCurrent').classList.toggle('hidden', t!=='current'); 
            document.getElementById('containerSlidersFuture').classList.toggle('hidden', t!=='future'); 
            document.getElementById('containerInputsCurrent').classList.toggle('hidden', t!=='current'); 
            document.getElementById('containerInputsFuture').classList.toggle('hidden', t!=='future'); 
            document.getElementById('tabCurrent').className=t==='current'?'flex-1 tab-btn tab-active':'flex-1 tab-btn tab-inactive'; 
            document.getElementById('tabFuture').className=t==='future'?'flex-1 tab-btn tab-active':'flex-1 tab-btn tab-inactive'; 
            
            const suffix = t === 'current' ? '(ä»Šã®è³‡ç”£)' : '(ç©ç«‹)';
            document.getElementById('chartLabelType').innerText = suffix;
            document.getElementById('riskLabelType').innerText = suffix;
            if(inputMode === 'amount') { document.getElementById('initialAsset').disabled = t === 'current'; document.getElementById('monthlyAdd').disabled = t === 'future'; syncPercentToAmounts(); }
            updateTotalBar(); 
            calculate(true); 
        }

        const targetLinePlugin = {
            id: 'targetLine',
            afterDatasetsDraw(chart, args, options) {
                if (graduationIndex === null) return;
                const { ctx, chartArea: { top, bottom }, scales: { x, y } } = chart;
                
                // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æç”»æ¸ˆã¿ã®ç‚¹ã®åº§æ¨™ã‚’ç›´æ¥å–å¾—ã™ã‚‹
                const meta = chart.getDatasetMeta(0);
                if (!meta.data[graduationIndex]) return; 

                const xPos = meta.data[graduationIndex].x;
                
                ctx.save();
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#facc15'; 
                ctx.setLineDash([6, 4]);
                ctx.moveTo(xPos, top);
                ctx.lineTo(xPos, bottom);
                ctx.stroke();
                
                ctx.fillStyle = '#facc15';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'left';
                const label = `ğŸš© ${chart.data.labels[graduationIndex]}æ­³ã§é”æˆ`;
                const textWidth = ctx.measureText(label).width;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(xPos + 4, top + 10, textWidth + 10, 20);
                
                ctx.fillStyle = '#facc15';
                ctx.fillText(label, xPos + 9, top + 24);
                
                ctx.restore();
            }
        };

        function drawMainChart(labels, dTotal, dPrin) {
            // ç¾åœ¨ã®å¹´é½¢
            const age = +document.getElementById('currentAge').value || 35;
            
            // Xè»¸ã®æœ€å¤§å€¤ã‚’ã€Œ80æ­³ã€ã¾ãŸã¯ã€Œç¾åœ¨+5å¹´ã€ã®å¤§ãã„æ–¹ã«è¨­å®š
            // ã“ã‚Œã«ã‚ˆã‚Šã€80æ­³ä»¥ä¸Šã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ ï¼‰ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹
            const initialMaxAge = Math.max(80, age + 5);

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label:'å…ƒæœ¬', data:dPrin, borderColor:'#94a3b8', backgroundColor:'#94a3b8', fill:false, pointRadius:0, borderWidth:2, order:1 },
                        { label:'è³‡ç”£ç·é¡', data:dTotal, borderColor:'#3b82f6', backgroundColor:'#3b82f6', fill:false, pointRadius:0, borderWidth:2, order:0 },
                        { label:'æ¯”è¼ƒ', data:lockedData || [], borderColor:'rgba(255,255,255,0.5)', borderDash:[5,5], pointRadius:0, fill:false, order:2, hidden:!lockedData }
                    ]
                },
                plugins: [targetLinePlugin],
                options: { 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins:{ 
                        legend:{labels:{color:'#94a3b8'}}, 
                        datalabels: { display: false },
                        tooltip: {
                            mode: 'index', intersect: false, backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                            titleColor: '#e2e8f0', bodyColor: '#cbd5e1', 
                            borderColor: 'rgba(148, 163, 184, 0.3)', borderWidth: 1, padding: 10,
                            callbacks: {
                                label: function(context) { 
                                    return ' ' + context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡'; 
                                },
                                footer: function(tooltipItems) {
                                    let total = 0, principal = 0;
                                    tooltipItems.forEach(function(item) {
                                        if (item.dataset.label === 'è³‡ç”£ç·é¡') total = item.raw;
                                        if (item.dataset.label === 'å…ƒæœ¬') principal = item.raw;
                                    });
                                    const profit = total - principal;
                                    const sign = profit > 0 ? '+' : '';
                                    return '\n å«ã¿ç›Š: ' + sign + profit.toLocaleString() + 'ä¸‡';
                                }
                            }
                        },
                        zoom: { 
                            limits: {
                                x: { min: age, max: age + 100 } // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã®ç¯„å›²åˆ¶é™
                            },
                            zoom: { 
                                wheel: { enabled: true }, 
                                pinch: { enabled: true }, 
                                mode: 'x' 
                            }, 
                            pan: { 
                                enabled: true, 
                                mode: 'x' 
                            } 
                        }
                    }, 
                    scales:{
                        x:{
                            grid:{display:false},
                            ticks:{color:'#64748b'},
                            min: age,         // åˆæœŸè¡¨ç¤ºã®é–‹å§‹ï¼ˆç¾åœ¨å¹´é½¢ï¼‰
                            max: initialMaxAge // åˆæœŸè¡¨ç¤ºã®çµ‚äº†ï¼ˆ80æ­³ï¼‰
                        }, 
                        y:{
                            beginAtZero: true, 
                            stacked:false, 
                            grid:{color:'#1e293b'},
                            ticks:{color:'#64748b'}
                        }
                    }, 
                }
            };

            const canvasPC = document.getElementById('chartCanvas');
            if(canvasPC) {
                const ctx = canvasPC.getContext('2d');
                if(myChart) myChart.destroy();
                myChart = new Chart(ctx, config);
            }

            const canvasMob = document.getElementById('chartCanvasMobile');
            if(canvasMob) {
                const ctxMob = canvasMob.getContext('2d');
                if(myChartMobile) myChartMobile.destroy();
                
                // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¨­å®šã‚³ãƒ”ãƒ¼
                const configMob = {
                    type: config.type,
                    data: {
                        labels: config.data.labels,
                        datasets: config.data.datasets.map(d => ({...d}))
                    },
                    plugins: [targetLinePlugin],
                    options: JSON.parse(JSON.stringify(config.options))
                };
                
                // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–¢æ•°ã®å†è¨­å®šï¼ˆJSON.parseã§æ¶ˆãˆã‚‹ãŸã‚ï¼‰
                configMob.options.plugins.tooltip.callbacks = config.options.plugins.tooltip.callbacks;

                myChartMobile = new Chart(ctxMob, configMob);
            }
        }

        function updateSubCharts(retVal, crashVal, pfData) {
            const ctxPf = document.getElementById('portfolioChart').getContext('2d');
            const ctxRr = document.getElementById('riskReturnChart').getContext('2d');
            if(pfChart) pfChart.destroy();
            pfChart = new Chart(ctxPf, { type: 'doughnut', plugins: [ChartDataLabels], data: { labels: pfData.map(d=>d.name), datasets: [{ data: pfData.map(d=>d.val), backgroundColor: pfData.map(d=>d.color), borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + Math.round(val) + '%', anchor: 'center', align: 'center' } }, cutout:'50%' } });
            if(rrChart) rrChart.destroy();
            rrChart = new Chart(ctxRr, { type: 'bar', plugins: [ChartDataLabels], data: { labels: ['æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³', 'æœ€å¤§ãƒªã‚¹ã‚¯'], datasets: [{ data: [parseFloat(retVal), parseFloat(crashVal)], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 4, maxBarThickness: 40 }] }, options: { responsive:true, maintainAspectRatio:false, layout: { padding: { top: 40 } }, indexAxis: 'x', plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (val) => val > 0 ? '+' + val + '%' : val + '%', anchor: 'end', align: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0 ? 'top' : 'bottom' } }, scales:{ x:{ grid:{display:false}, ticks:{color:'#94a3b8', font:{size:10}} }, y:{ grid:{color:'#334155'}, ticks:{color:'#64748b'}, beginAtZero:true } } } });
        }

        function lockComparison() { if(myChart) { lockedData = [...myChart.data.datasets[1].data]; alert('å›ºå®šã—ã¾ã—ãŸ'); calculate(false); } }
        function renderAchievement(age) { document.getElementById('achievementMobile').innerHTML = age ? `<div class="bg-yellow-600/80 p-2 rounded text-white font-bold mb-2">ğŸ‰ ${age}æ­³ã§é”æˆï¼</div>` : `<div class="bg-slate-800 p-2 rounded text-gray-400 mb-2">æœªé”...</div>`; document.getElementById('achievementDesktop').innerHTML = document.getElementById('achievementMobile').innerHTML; }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ currentAge:document.getElementById('currentAge').value })); } 
        function loadState() { try { const s=JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){} }
        function exportSettings() { const s=localStorage.getItem(STORAGE_KEY); if(s){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([s],{type:'application/json'})); a.download='fire_sim_data.json'; a.click(); } }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importSettings(e) { const r=new FileReader(); r.onload=function(e){localStorage.setItem(STORAGE_KEY,e.target.result); loadState(); calculate(false); alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');}; r.readAsText(e.files[0]); }
        function downloadChart() { const a=document.createElement('a'); a.href=document.getElementById('chartCanvas').toDataURL(); a.download='chart.png'; a.click(); }
        function rerollCrash() { memoCrashYears=[]; calculate(false); }
    </script>
</body>
</html>
