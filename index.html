<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Simulator v70.22 - Config Fix</title>
    <!-- Chart.js æœ¬ä½“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ« -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ (å®‰å®šç‰ˆ v1.2.1 + Hammer.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #0b0f19; 
            color: #e2e8f0; 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 20%); 
            background-attachment: fixed; 
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 1023px) {
            body {
                overflow-y: auto;
                height: auto;
            }
        }

        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; border-radius: 8px; width: 100%; padding: 8px; font-weight: bold; text-align: center; }
        .glass-input:disabled { background: rgba(15, 23, 42, 0.3); color: #64748b; border-color: transparent; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .config-modal-content { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 20px; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: rgba(148, 163, 184, 0.2); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #60a5fa; margin-top: -6px; border: 2px solid #1e293b; }
        
        .tab-btn { transition: all 0.3s; padding: 8px 4px; border-radius: 8px; font-weight: bold; font-size: 11px; cursor: pointer; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .tab-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; border: 1px solid rgba(255,255,255,0.05); }
        
        header { padding: 1rem 2rem; flex: 0 0 auto; z-index: 10; }

        @media (min-width: 1024px) {
            .container-grid { 
                display: grid; 
                grid-template-columns: 500px 1fr; 
                gap: 30px; 
                padding: 0 30px 20px 30px; 
                max-width: 100%; 
                margin: 0;
                align-items: start;
                height: calc(100vh - 80px);
                width: 100%;
                overflow: hidden; /* PCã§ã¯å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
            }
            .input-column { 
                height: 100%;
                overflow-y: auto; 
                padding-right: 10px; 
                padding-bottom: 20px;
            }
            .result-column {
                height: 100%;
                overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
                display: flex;
                flex-direction: column;
                gap: 12px; /* è¦ç´ é–“ã®éš™é–“ã‚’èª¿æ•´ */
                padding-bottom: 10px; 
                padding-right: 5px;
            }
        }

        @media (max-width: 1023px) {
            .container-grid { display: block; padding: 16px; height: auto; overflow: visible; }
            .input-column { margin-bottom: 40px; height: auto; overflow-y: visible; }
            .mobile-only-block { display: block; margin-bottom: 30px; }
            .pc-only { display: none !important; }
            .result-column { display: none; } 
        }

        /* PCã§ã®ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠé«˜ã•åˆ¶å¾¡ (Flexboxã§è‡ªå‹•ä¼¸ç¸®) */
        .main-chart-container { 
            position: relative; 
            width: 100%; 
            height: 300px; /* é«˜ã•ã‚’å°‘ã—ç¸®å°ã—ã¦ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è­²ã‚‹ */
            flex: 3; 
            min-height: 0; 
            margin: 0;
            cursor: grab; 
            touch-action: none;
        }
        .main-chart-container:active { cursor: grabbing; }

        .sub-charts-container { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px; 
            width: 100%;
            margin: 0;
            height: 280px; /* é«˜ã•ã‚’å¢—ã‚„ã—ã¦ã¤ã¶ã‚Œé˜²æ­¢ */
            flex: 2; 
            min-height: 0; 
            flex-shrink: 0;
        }
        
        .sub-charts-container .glass-card {
            height: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
        }
        
        .chart-inner-wrapper {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            padding-top: 10px; 
            min-height: 0;
        }

        .result-summary-card { 
            width: 100%;
            margin: 0;
            padding: 12px 16px;
            flex-shrink: 0; /* ã“ã‚Œä»¥ä¸Šç¸®ã‚ãªã„ */
        }

        .mobile-only-block { display: none; }
        @media (max-width: 1023px) {
            .mobile-only-block { display: block; }
            .sub-charts-container { grid-template-columns: 1fr; height: auto; }
            .sub-charts-container .glass-card { height: 280px; margin-bottom: 0; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
</head>
<body>

    <header>
        <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">FIRE Simulator <span class="text-xs text-gray-500 ml-1">v70.22</span></h1>
    </header>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒˆãƒƒãƒ—ã‚¨ãƒªã‚¢ï¼šã‚µãƒãƒªãƒ¼ã®ã¿ -->
    <div class="lg:hidden p-4 pb-0 mobile-only-block">
        <div class="glass-card p-4">
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-[9px] text-gray-500 mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p>
                    <p class="text-2xl font-black text-yellow-400">
                        <span id="resPeakAssetMobile">0</span><span class="text-xs ml-1">ä¸‡</span>
                    </p>
                </div>
                <div class="border-l border-slate-700">
                    <p class="text-[9px] text-gray-500 mb-0.5">100æ­³æ™‚ç‚¹</p>
                    <p class="text-xl font-bold text-gray-200">
                        <span id="resEndAssetMobile">0</span><span class="text-xs ml-1">ä¸‡</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container-grid">
        <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå…¥åŠ› (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½) -->
        <div class="input-column">
            <div id="achievementMobile" class="lg:hidden mb-4"></div>

            <div class="glass-card p-4 mb-5">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-blue-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-blue-300">PROFILE</h2></div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨ã®å¹´é½¢</label><input type="number" id="currentAge" value="35" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨è³‡ç”£ (ä¸‡)</label><input type="number" id="initialAsset" value="500" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">æ¯æœˆç©ç«‹ (ä¸‡)</label><input type="number" id="monthlyAdd" value="10" class="glass-input"></div>
                    <div><label class="text-[10px] text-yellow-500 block mb-1">ç›®æ¨™é‡‘é¡ (ä¸‡)</label><input type="number" id="targetAsset" value="3000" class="glass-input border-yellow-500/30 text-yellow-100"></div>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="bg-blue-900/20 p-2 rounded-lg flex items-center gap-2">
                        <input type="checkbox" id="coastFireMode" class="w-4 h-4" onchange="calculate(false)"><label for="coastFireMode" class="text-[10px] font-bold text-blue-200 cursor-pointer">ç›®æ¨™é”æˆã§ç©ç«‹åœæ­¢</label>
                    </div>
                    <!-- New Option: DCA Protection -->
                    <div class="bg-emerald-900/20 p-2 rounded-lg flex items-center gap-2">
                        <input type="checkbox" id="protectDCA" class="w-4 h-4" onchange="calculate(false)"><label for="protectDCA" class="text-[10px] font-bold text-emerald-200 cursor-pointer">æš´è½å¹´ã®ç©ç«‹ã‚’ä¿è­· (ãƒ‰ãƒ«ã‚³ã‚¹ãƒˆæ³•)</label>
                    </div>
                </div>
                <div id="graduationAgeArea" class="hidden mt-2 text-center"><span class="bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded text-[10px] font-bold">ğŸ‰ <span id="graduationAge">0</span>æ­³ã§å’æ¥­</span></div>
            </div>

            <div class="glass-card p-4 mb-5">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center"><div class="w-1 h-4 bg-purple-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-purple-300">PORTFOLIO</h2></div>
                    <button onclick="openConfigModal()" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-gray-300 px-2 py-1 rounded flex items-center gap-1">âš™ è¡¨ç¤ºé …ç›®è¨­å®š</button>
                </div>

                <div class="flex justify-between items-center mb-4 bg-slate-900/50 p-1 rounded-lg">
                    <button onclick="setInputMode('percent')" id="btnModePercent" class="flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600">ï¼…æŒ‡å®šãƒ¢ãƒ¼ãƒ‰</button>
                    <button onclick="setInputMode('amount')" id="btnModeAmount" class="flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white">é‡‘é¡æŒ‡å®šãƒ¢ãƒ¼ãƒ‰</button>
                </div>

                <div class="flex gap-2 mb-4">
                    <div id="tabCurrent" onclick="switchTab('current')" class="flex-1 tab-btn tab-active">ä»Šã®è³‡ç”£</div>
                    <div id="tabFuture" onclick="switchTab('future')" class="flex-1 tab-btn tab-inactive">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</div>
                    <div id="tabAfter" onclick="switchTab('after')" class="flex-1 tab-btn tab-inactive">é”æˆå¾Œã®é…åˆ†</div>
                </div>

                <div id="uiPercentMode">
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <button onclick="applyPreset('defensive')" class="bg-emerald-900/30 text-emerald-400 text-[10px] py-2 rounded">ğŸ›¡ï¸ é‰„å£</button>
                        <button onclick="applyPreset('standard')" class="bg-blue-900/30 text-blue-400 text-[10px] py-2 rounded">ğŸ‘‘ ç‹é“</button>
                        <button onclick="applyPreset('aggressive')" class="bg-purple-900/30 text-purple-400 text-[10px] py-2 rounded">ğŸš€ çˆ†ç›Š</button>
                    </div>
                    <div class="mb-5 bg-slate-800 rounded-full h-2 overflow-hidden"><div id="totalProgressBar" class="h-full bg-blue-500 transition-all" style="width: 100%"></div></div>
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒŠ: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                    <div id="containerSlidersCurrent" class="block"><div id="slidersCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerSlidersFuture" class="hidden"><div id="slidersFuture" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerSlidersAfter" class="hidden"><div id="slidersAfter" class="grid grid-cols-2 gap-3"></div></div>
                </div>

                <div id="uiAmountMode" class="hidden">
                    <p class="text-[10px] text-yellow-500 mb-2 text-center bg-yellow-900/20 py-1 rounded">å„è³‡ç”£ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒŠ: é‡‘é¡å…¥åŠ› -->
                    <div id="containerInputsCurrent" class="block"><div id="inputsCurrent" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerInputsFuture" class="hidden"><div id="inputsFuture" class="grid grid-cols-2 gap-3"></div></div>
                    <div id="containerInputsAfter" class="hidden"><div id="inputsAfter" class="grid grid-cols-2 gap-3"></div></div>
                    
                    <div class="mt-4 text-center border-t border-slate-700/50 pt-3">
                        <p class="text-[10px] text-gray-400">å…¥åŠ›åˆè¨ˆ</p>
                        <p class="text-xl font-black text-white"><span id="amountModeTotal">0</span> <span class="text-xs">ä¸‡å††</span></p>
                    </div>
                </div>
                
                <div class="mt-5 pt-4 border-t border-slate-700/50 grid grid-cols-3 gap-2 text-center">
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold mb-1">ç¾åœ¨ã®PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-blue-400"><span id="tabRetCurrent">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskCurrent">0.0</span>%</span></div>
                    </div>
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold">ç©ç«‹PF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-green-400"><span id="tabRetFuture">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskFuture">0.0</span>%</span></div>
                    </div>
                    <div class="bg-slate-800/40 p-2 rounded-lg">
                        <p class="text-[9px] text-gray-500 font-bold">é”æˆå¾ŒPF</p>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">å¹´åˆ©</span><span class="text-sm font-black text-indigo-400"><span id="tabRetAfter">0.0</span>%</span></div>
                        <div class="flex justify-between px-1"><span class="text-[10px] text-gray-400">ãƒªã‚¹ã‚¯</span><span class="text-sm font-black text-red-400"><span id="tabRiskAfter">0.0</span>%</span></div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šã‚°ãƒ©ãƒ•ã‚’ã“ã“ã«ç§»å‹• -->
            <div class="lg:hidden mobile-only-block mb-5">
                <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼†ã‚¿ãƒ– -->
                <div class="flex justify-between items-center mb-2 px-1">
                    <span class="text-[10px] text-gray-500 font-bold">CHART CONTROL</span>
                    <button onclick="resetChartZoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-[10px] font-bold flex items-center gap-1">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div id="chartTabContainerMobile" class="flex gap-1 overflow-x-auto mb-2 pb-1 whitespace-nowrap scrollbar-hide flex-shrink-0" style="min-height: 32px;"></div>

                <div class="glass-card p-2 h-[280px] relative">
                    <canvas id="chartCanvasMobile"></canvas>
                </div>
                <p class="text-[10px] text-gray-500 text-center mt-2">â€» ãƒ”ãƒ³ãƒã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã§æ‹¡å¤§ç¸®å°å¯èƒ½</p>
            </div>

            <div class="mb-5 glass-card p-4">
                <p class="text-[10px] text-gray-400 mb-2 text-center font-bold">ASSET SPEC (10 YEARS)</p>
                <div class="flex justify-center gap-8 text-center">
                    <div><p class="text-[9px] text-gray-500">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</p><p class="text-2xl font-black text-white"><span id="specTotalRet">0.0</span>%</p></div>
                    <div><p class="text-[9px] text-gray-500">æœ€å¤§ãƒªã‚¹ã‚¯</p><p class="text-2xl font-black text-red-500"><span id="specTotalCrash">0.0</span>%</p></div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-indigo-500/20">
                <h2 class="text-xs font-bold text-indigo-300 mb-3">EXIT & CRASH</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawAge" value="60" class="glass-input"></div>
                    <div><label class="text-[10px] text-gray-400">æš´è½è¨­å®š</label><select id="crashCount" class="glass-input text-xs"><option value="0">ãªã—</option><option value="2">2å›</option><option value="5" selected>5å›</option><option value="8">8å›</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400">å–å´©ç‡(%)</label><input type="number" id="num_withdrawRate" value="4.0" class="glass-input"></div>
                    <div>
                        <label class="text-[10px] text-gray-400">æš´è½æ™‚æœŸ</label>
                        <select id="crashTimingMode" class="glass-input text-xs" onchange="calculate(false)">
                            <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
                            <option value="early">åºç›¤</option>
                            <option value="middle">ä¸­ç›¤</option>
                            <option value="late">çµ‚ç›¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="rerollCrash()" class="w-full bg-slate-700 text-xs py-2 rounded mb-3">ğŸ² æš´è½ã‚·ãƒŠãƒªã‚ªå†æŠ½é¸</button>
                
                <h2 class="text-xs font-bold text-slate-300 mb-2 mt-4">DATA</h2>
                <div class="flex gap-2 mb-2">
                    <button onclick="lockComparison()" class="flex-1 bg-indigo-600 text-white text-xs font-bold py-2 rounded">ğŸ“Œ æ¯”è¼ƒç”¨ã«å›ºå®š</button>
                    <button onclick="unlockComparison()" class="bg-slate-700 text-gray-300 text-xs py-2 rounded px-3">è§£é™¤</button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="exportSettings()" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">ä¿å­˜</button>
                    <label class="flex-1 bg-slate-700 text-white text-xs py-2 rounded text-center cursor-pointer hover:bg-slate-600 transition-colors">
                        èª­è¾¼
                        <input type="file" id="importFile" class="hidden" onchange="importSettings(this)" onclick="this.value = null">
                    </label>
                </div>

                <!-- ğŸ¤– AI Prompt Button -->
                <div class="mb-4">
                    <button onclick="openPromptModal()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-teal-500/20 flex items-center justify-center gap-2 transition-all transform hover:scale-[1.02]">
                        <span>ğŸ“‹</span> å¤–éƒ¨AIç›¸è«‡ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
                    </button>
                </div>

                <h2 class="text-xs font-bold text-blue-300 mb-2">SHARE</h2>
                <div class="flex gap-2">
                    <button onclick="shareToX()" class="flex-1 bg-black text-white text-xs font-bold py-2 rounded border border-gray-700">X ãƒã‚¹ãƒˆ</button>
                    <button onclick="copyResult()" class="bg-slate-700 text-white text-xs py-2 rounded px-3">ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
            
            <div class="space-y-3 mb-10 text-center">
                <a href="#" class="block bg-gradient-to-r from-blue-700 to-blue-600 p-3 rounded-lg text-white font-bold text-xs">SBIè¨¼åˆ¸ å£åº§é–‹è¨­ (PR)</a>
                <a href="#" class="block bg-gradient-to-r from-emerald-700 to-emerald-600 p-3 rounded-lg text-white font-bold text-xs">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ (PR)</a>
            </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ ï¼šçµæœãƒ»ã‚°ãƒ©ãƒ• (PCç”¨: åŸºæœ¬å›ºå®šã€å¿…è¦ã«å¿œã˜ã¦å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) -->
        <div class="result-column pc-only">
            <div id="achievementDesktop" class="hidden lg:block mb-4"></div>

            <div class="flex justify-between items-center px-1">
                <span class="text-[9px] text-gray-500 font-bold">SIMULATION CHART</span>
                <div class="flex gap-2">
                    <button onclick="resetChartZoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-[10px] font-bold flex items-center gap-1">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button onclick="downloadChart()" class="bg-slate-800 text-gray-300 px-2 py-1 rounded text-[10px]">ç”»åƒä¿å­˜</button>
                </div>
            </div>
            
            <!-- NEW: Tabs container (ä¿®æ­£: ã¤ã¶ã‚Œãªã„ã‚ˆã†ã«flex-shrinkã‚’0ã«) -->
            <div id="chartTabContainer" class="flex gap-1 overflow-x-auto mb-2 pb-1 whitespace-nowrap scrollbar-hide flex-shrink-0" style="min-height: 32px;">
                <!-- Tabs will be injected here -->
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="glass-card p-2 main-chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>

            <!-- ã‚µãƒ–ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="sub-charts-container">
                <div class="glass-card p-2 text-center relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 absolute top-2 left-0 w-full z-10">ASSET ALLOCATION <span id="chartLabelType" class="text-blue-400"></span></p>
                    <div class="chart-inner-wrapper">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-2 text-center relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 absolute top-2 left-0 w-full z-10">RISK SCENARIO <span id="riskLabelType" class="text-blue-400"></span></p>
                    <div class="chart-inner-wrapper">
                        <canvas id="riskReturnChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- çµæœè¦ç´„ (PCç”¨) -->
            <div class="result-summary-card glass-card p-4">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[9px] text-gray-500 mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p><p class="text-2xl font-black text-yellow-400"><span id="resPeakAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                    <div class="border-l border-slate-700"><p class="text-[9px] text-gray-500 mb-0.5">100æ­³æ™‚ç‚¹</p><p class="text-xl font-bold text-gray-200"><span id="resEndAsset">0</span><span class="text-xs ml-1">ä¸‡</span></p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal-overlay">
        <div class="config-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">è¡¨ç¤ºé …ç›®ã®é¸æŠ</h3>
                <button onclick="closeConfigModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <p class="text-xs text-gray-500 mb-4">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸè³‡ç”£ã¯å…¥åŠ›æ¬„ã¨ã‚°ãƒ©ãƒ•ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚</p>
            <div id="assetConfigList" class="space-y-2 mb-4"></div>
            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <!-- PROMPT MODAL -->
    <div id="promptModal" class="modal-overlay">
        <div class="config-modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">AIç›¸è«‡ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                <button onclick="closePromptModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <p class="text-xs text-gray-400 mb-2">ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ChatGPTã‚„Geminiãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ç›¸è«‡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
            <textarea id="promptTextarea" class="w-full h-64 bg-slate-900 border border-slate-700 rounded p-3 text-xs text-gray-300 mb-4 focus:outline-none focus:border-blue-500" readonly></textarea>
            <button onclick="copyPromptText()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition-colors flex items-center justify-center gap-2">
                <span id="copyBtnLabel">ã‚³ãƒ”ãƒ¼ã™ã‚‹</span>
            </button>
        </div>
    </div>

    <script>
        try { if (typeof ChartDataLabels !== 'undefined') Chart.unregister(ChartDataLabels); } catch(e) {}

        const STORAGE_KEY = 'simulatorState_v70';
        const CONFIG_KEY = 'simulatorConfig_v70';
        
        // åˆæœŸå€¤ã‚’å¤‰æ›´: 500ä¸‡ã€S&P500 30%ã€ç¾é‡‘ 70%
        // defA (After Graduation Default) ã‚’è¿½åŠ  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯futureã¨åŒã˜ã«ã—ã¦ãŠã)
        const ASSETS_DEF = [
            { key: 'cash', name: 'ğŸ’´ ç¾é‡‘', desc: 'æ—¥æœ¬å††ã€‚æš´è½æ™‚ã®ã‚¯ãƒƒã‚·ãƒ§ãƒ³', color: '#64748b', ret: 0.00, crash: 1.00, defC: 70, defF: 70, defA: 70 },
            { key: 'bond', name: 'ğŸ“œ å‚µåˆ¸', desc: 'ç±³å›½å‚µç­‰ã€‚æ ªã¨é€†ã®å‹•ã', color: '#2dd4bf', ret: 0.03, crash: 0.95, defC: 0, defF: 0, defA: 0 },
            { key: 'gold', name: 'ğŸ¥‡ é‡‘',    desc: 'æœ‰äº‹ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬ã«å¼·ã„', color: '#fbbf24', ret: 0.04, crash: 0.85, defC: 0, defF: 0, defA: 0 },
            { key: 'reit', name: 'ğŸ¢ ä¸å‹•ç”£', desc: 'å®¶è³ƒåå…¥ã€‚ãƒŸãƒ‰ãƒ«ãƒªã‚¹ã‚¯', color: '#a855f7', ret: 0.045, crash: 0.75, defC: 0, defF: 0, defA: 0 },
            { key: 'orkan', name: 'ğŸ›¡ï¸ ã‚ªãƒ«ã‚«ãƒ³', desc: 'å…¨ä¸–ç•Œåˆ†æ•£ã€‚ç‹é“ã®æŠ•è³‡å…ˆ', color: '#10b981', ret: 0.05, crash: 0.75, defC: 50, defF: 50, defA: 50 },
            { key: 'sp500', name: 'âš”ï¸ S&P500', desc: 'ç±³å›½ä¸»è¦500ç¤¾ã«æŠ•è³‡', color: '#3b82f6', ret: 0.10, crash: 0.60, defC: 30, defF: 30, defA: 30 },
            { key: 'nasdaq', name: 'ğŸ’» NASDAQ100', desc: 'ç±³å›½ã®ãƒã‚¤ãƒ†ã‚¯ä¸­å¿ƒ100ç¤¾', color: '#06b6d4', ret: 0.13, crash: 0.50, defC: 0, defF: 0, defA: 0 },
            { key: 'fang', name: 'ğŸ’ FANG+', desc: 'å·¨å¤§ITä¼æ¥­10ç¤¾ã«é›†ä¸­', color: '#f472b6', ret: 0.17, crash: 0.45, defC: 0, defF: 0, defA: 0 },
            { key: 'cyc', name: 'ğŸ”¥ æ™¯æ°—æ•æ„Ÿæ ª', desc: 'é‡‘è/ç´ æã€‚æ™¯æ°—ã§å¤‰å‹•å¤§', color: '#ef4444', ret: 0.15, crash: 0.45, defC: 0, defF: 0, defA: 0 },
            { key: 'def', name: 'ğŸ›¡ï¸ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹æ ª', desc: 'ç”Ÿæ´»å¿…éœ€å“/ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢', color: '#84cc16', ret: 0.06, crash: 0.75, defC: 0, defF: 0, defA: 0 },
            { key: 'cryp', name: 'â‚¿ ä»®æƒ³é€šè²¨', desc: 'BTCç­‰ã€‚è¶…ãƒã‚¤ãƒªã‚¹ã‚¯', color: '#8b5cf6', ret: 0.30, crash: 0.30, defC: 0, defF: 0, defA: 0 },
            { key: 'lev', name: 'ğŸš€ ãƒ¬ãƒãƒŠã‚¹', desc: 'NASDAQã®2å€ã®å€¤å‹•ã', color: '#ec4899', ret: 0.25, crash: 0.25, defC: 0, defF: 0, defA: 0 }
        ];

        let activeTab = 'current';
        let inputMode = 'percent'; 
        let visibleAssets = {}; 
        let myChart = null, myChartMobile = null, pfChart = null, rrChart = null;
        let memoCrashYears = [], memoCrashKey = '', lockedData = null;
        let graduationIndex = null; 
        
        // For AI Analysis context
        let currentAnalysisContext = {};

        window.onload = () => {
            if (typeof ChartZoom !== 'undefined') {
                Chart.register(ChartZoom); 
            }
            
            loadConfig();
            renderUI();
            
            document.querySelectorAll('input, select').forEach(el => {
                if(el.id.startsWith('amt_')) return;
                if(el.type === 'checkbox' && el.id !== 'coastFireMode' && el.id !== 'protectDCA') return; 
                if(el.type !== 'checkbox') el.addEventListener(el.type==='range'?'input':'change', () => calculate(false));
            });
            
            loadState();
            setInputMode('percent');
            calculate(false);
        };

        function loadConfig() {
            try {
                const s = JSON.parse(localStorage.getItem(CONFIG_KEY));
                if (s) visibleAssets = s;
                else ASSETS_DEF.forEach(a => visibleAssets[a.key] = true);
            } catch(e) { ASSETS_DEF.forEach(a => visibleAssets[a.key] = true); }
        }

        function getActiveAssets() { return ASSETS_DEF.filter(a => visibleAssets[a.key] !== false); }

        function renderUI() {
            const assets = getActiveAssets();
            // Loop for current, future, AND after
            ['current', 'future', 'after'].forEach(type => {
                let defaultValKey = type === 'current' ? 'defC' : (type === 'future' ? 'defF' : 'defA');
                document.getElementById(`sliders${type.charAt(0).toUpperCase()+type.slice(1)}`).innerHTML = assets.map(a => `
                    <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-700/50">
                        <div class="flex justify-between mb-0.5"><span style="color:${a.color}" class="font-bold text-[10px]">${a.name}</span><input type="number" id="num_${type}_${a.key}" value="${a[defaultValKey]}" class="bg-slate-900 border border-slate-600 rounded w-10 text-right text-xs text-white" oninput="syncRange('range_${type}_${a.key}', this.value)"></div>
                        <div class="text-[8px] text-gray-500 mb-1">${a.desc}</div>
                        <input type="range" id="range_${type}_${a.key}" value="${a[defaultValKey]}" min="0" max="100" class="w-full" oninput="syncNum('num_${type}_${a.key}', this.value)">
                    </div>`).join('');
                document.getElementById(`inputs${type.charAt(0).toUpperCase()+type.slice(1)}`).innerHTML = assets.map(a => `
                    <div class="bg-slate-800/20 p-1.5 rounded">
                        <label class="text-[10px] font-bold block mb-0.5" style="color:${a.color}">${a.name}</label>
                        <div class="text-[8px] text-gray-500 mb-1">${a.desc}</div>
                        <input type="number" id="amt_${type}_${a.key}" class="glass-input text-right text-sm" placeholder="0" oninput="onAmountInput('${type}')">
                    </div>`).join('');
            });
            document.getElementById('assetConfigList').innerHTML = ASSETS_DEF.map(a => `
                <div class="flex items-center justify-between bg-slate-800 p-2 rounded">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background:${a.color}"></div><span class="text-sm font-bold text-gray-300">${a.name}</span></div>
                    <input type="checkbox" class="w-5 h-5" id="cfg_${a.key}" ${visibleAssets[a.key]!==false?'checked':''}>
                </div>`).join('');
        }

        function openConfigModal() { document.getElementById('configModal').style.display = 'flex'; }
        function closeConfigModal() { document.getElementById('configModal').style.display = 'none'; }
        
        function saveConfig() {
            // 1. UIå†æ§‹ç¯‰å‰ã«ã€ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é …ç›®ã®å€¤ã ã‘ã‚’é€€é¿ã™ã‚‹
            // (éè¡¨ç¤ºã®é …ç›®ã¯DOMãŒãªã„ã®ã§ä¿å­˜ã•ã‚Œãªã„ -> å†è¡¨ç¤ºæ™‚ã¯åˆæœŸå€¤ã«ãªã‚‹)
            const savedStates = {};
            ASSETS_DEF.forEach(a => {
                // DOMãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if (document.getElementById(`range_current_${a.key}`)) {
                    savedStates[a.key] = {
                        current: document.getElementById(`range_current_${a.key}`).value,
                        future: document.getElementById(`range_future_${a.key}`).value,
                        after: document.getElementById(`range_after_${a.key}`).value,
                        amtCurrent: document.getElementById(`amt_current_${a.key}`)?.value || 0,
                        amtFuture: document.getElementById(`amt_future_${a.key}`)?.value || 0
                    };
                }
            });

            // 2. è¨­å®šã‚’ä¿å­˜
            ASSETS_DEF.forEach(a => visibleAssets[a.key] = document.getElementById(`cfg_${a.key}`).checked);
            localStorage.setItem(CONFIG_KEY, JSON.stringify(visibleAssets));

            // 3. UIå†æç”» (ã“ã“ã§DOMãŒå†ç”Ÿæˆã•ã‚Œã€ã™ã¹ã¦åˆæœŸå€¤ã«æˆ»ã‚‹)
            renderUI();

            // 4. é€€é¿ã—ãŸå€¤ã‚’å¾©å…ƒã™ã‚‹
            ASSETS_DEF.forEach(a => {
                if (savedStates[a.key]) {
                    // ç›´å‰ã¾ã§è¡¨ç¤ºã•ã‚Œã¦ã„ãŸé …ç›®: é€€é¿ã—ãŸå€¤ã‚’æˆ»ã™
                    const d = savedStates[a.key];
                    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
                    
                    setVal(`range_current_${a.key}`, d.current);
                    setVal(`num_current_${a.key}`, d.current);
                    setVal(`range_future_${a.key}`, d.future);
                    setVal(`num_future_${a.key}`, d.future);
                    setVal(`range_after_${a.key}`, d.after);
                    setVal(`num_after_${a.key}`, d.after);
                    
                    setVal(`amt_current_${a.key}`, d.amtCurrent);
                    setVal(`amt_future_${a.key}`, d.amtFuture);
                }
                // ç›´å‰ã¾ã§éè¡¨ç¤ºã ã£ãŸé …ç›® (ä»Šå›ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸé …ç›®):
                // savedStates ã«ã¯ãªã„ã®ã§ã€ã“ã“ã¯ä½•ã‚‚ã—ãªã„ã€‚
                // çµæœã¨ã—ã¦ã€renderUI() ã§è¨­å®šã•ã‚ŒãŸåˆæœŸå€¤ (ASSETS_DEFã®defCãªã©) ãŒä½¿ã‚ã‚Œã‚‹ã€‚
                // ã“ã‚Œã«ã‚ˆã‚Šã€Œ0%ã€ã§ã¯ãªãã€Œé©åˆ‡ãªåˆæœŸå€¤ã€ã§å¾©æ´»ã™ã‚‹ã€‚
            });

            closeConfigModal();
            setInputMode(inputMode);
            calculate(false);
        }

        function resetChartZoom() { 
            // "å…¨æœŸé–“"ãƒœã‚¿ãƒ³ã‚’æ¢ã—ã¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ (PC/Mobileã©ã¡ã‚‰ã‹ãŒã‚ã‚Œã°ã‚ˆã„)
            const allTab = document.querySelector('.chart-period-btn[data-min]'); 
            if (allTab) {
                const min = +allTab.getAttribute('data-min');
                const max = +allTab.getAttribute('data-max');
                updateChartRange(min, max);
            } else if(myChart) {
                // ä¸‡ãŒä¸€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const age = +document.getElementById('currentAge').value || 35;
                myChart.resetZoom();
                myChart.options.scales.x.min = age;
                myChart.options.scales.x.max = 105;
                myChart.update();
                if(myChartMobile) {
                    myChartMobile.resetZoom();
                    myChartMobile.options.scales.x.min = age;
                    myChartMobile.options.scales.x.max = 105;
                    myChartMobile.update();
                }
            }
        }

        function setInputMode(mode) {
            inputMode = mode;
            const isPct = mode === 'percent';
            document.getElementById('btnModePercent').className = isPct ? "flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600 transition-colors" : "flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition-colors";
            document.getElementById('btnModeAmount').className = !isPct ? "flex-1 py-1 text-[10px] font-bold rounded text-white bg-blue-600 transition-colors" : "flex-1 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition-colors";
            document.getElementById('uiPercentMode').classList.toggle('hidden', !isPct);
            document.getElementById('uiAmountMode').classList.toggle('hidden', isPct);
            if(isPct) { syncAmountsToPercent(); document.getElementById('initialAsset').disabled = false; document.getElementById('monthlyAdd').disabled = false; } 
            else { 
                syncPercentToAmounts(); 
                if(activeTab === 'current') document.getElementById('initialAsset').disabled = true; 
                if(activeTab === 'future') document.getElementById('monthlyAdd').disabled = true; 
                if(activeTab === 'after') { /* after mode amount input logic not strictly bound to a total yet, maybe handled in sync */ }
            }
        }

        function onAmountInput(type) {
            const assets = getActiveAssets();
            let total = 0;
            assets.forEach(a => { const el = document.getElementById(`amt_${type}_${a.key}`); if(el) total += Number(el.value) || 0; });
            // Only update main inputs for current/future
            if(type === 'current') { document.getElementById('amountModeTotal').innerText = total.toLocaleString(); document.getElementById('initialAsset').value = total; }
            else if (type === 'future') { document.getElementById('amountModeTotal').innerText = total.toLocaleString(); document.getElementById('monthlyAdd').value = total; }
            else { document.getElementById('amountModeTotal').innerText = '-'; } // After doesn't have a fixed total input

            if(total > 0) assets.forEach(a => { const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0; const pct = (val / total) * 100; const rng = document.getElementById(`range_${type}_${a.key}`); const num = document.getElementById(`num_${type}_${a.key}`); if(rng) rng.value = pct; if(num) num.value = pct.toFixed(1); });
            calculate(false);
        }

        function syncPercentToAmounts() {
            const assets = getActiveAssets();
            const totalC = Number(document.getElementById('initialAsset').value) || 0;
            const totalF = Number(document.getElementById('monthlyAdd').value) || 0;
            let wC = 0, wF = 0, wA = 0;
            assets.forEach(a => { 
                wC += Number(document.getElementById(`range_current_${a.key}`).value)||0; 
                wF += Number(document.getElementById(`range_future_${a.key}`).value)||0; 
                wA += Number(document.getElementById(`range_after_${a.key}`).value)||0;
            });
            assets.forEach(a => {
                const pC = Number(document.getElementById(`range_current_${a.key}`).value)||0;
                document.getElementById(`amt_current_${a.key}`).value = Math.round(wC > 0 ? (pC / wC) * totalC : 0);
                const pF = Number(document.getElementById(`range_future_${a.key}`).value)||0;
                document.getElementById(`amt_future_${a.key}`).value = Math.round(wF > 0 ? (pF / wF) * totalF : 0);
                // For 'after', we don't have a fixed base amount, so maybe skip or use target? 
                // Let's just use 100 as base for display if needed or keep 0
                const pA = Number(document.getElementById(`range_after_${a.key}`).value)||0;
                document.getElementById(`amt_after_${a.key}`).value = 0; // Not really used in amount mode for logic
            });
            if(activeTab === 'current') document.getElementById('amountModeTotal').innerText = totalC.toLocaleString();
            else if(activeTab === 'future') document.getElementById('amountModeTotal').innerText = totalF.toLocaleString();
            else document.getElementById('amountModeTotal').innerText = '-';
        }

        function syncAmountsToPercent() {
            ['current', 'future', 'after'].forEach(type => {
                const assets = getActiveAssets();
                let total = 0;
                assets.forEach(a => total += Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0);
                if(total > 0) assets.forEach(a => { const val = Number(document.getElementById(`amt_${type}_${a.key}`).value) || 0; const pct = (val / total) * 100; const rng = document.getElementById(`range_${type}_${a.key}`); const num = document.getElementById(`num_${type}_${a.key}`); if(rng) rng.value = pct; if(num) num.value = pct.toFixed(1); });
            });
        }

        function syncNum(id, v) { document.getElementById(id).value=v; calculate(false); }
        function syncRange(id, v) { document.getElementById(id).value=Math.max(0,Math.min(100,v)); calculate(false); }

        function updateTotalBar() { 
            let t=0; getActiveAssets().forEach(a=>t+=parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value)||0); 
            const bar = document.getElementById('totalProgressBar');
            if(bar) bar.style.width=Math.min(t,100)+'%'; 
        }

        function applyPreset(t) { 
            if(inputMode === 'amount') { setInputMode('percent'); }
            let c={}; if(t==='defensive')c={cash:20,bond:30,gold:20,orkan:30}; else if(t==='standard')c={orkan:40,sp500:60}; else if(t==='aggressive')c={nasdaq:30,fang:20,cyc:20,cryp:10,lev:20}; 
            getActiveAssets().forEach(a=>{ let v=c[a.key]||0; document.getElementById(`range_${activeTab}_${a.key}`).value=v; document.getElementById(`num_${activeTab}_${a.key}`).value=v; }); 
            calculate(false); 
        }

        function renderChartTabs(currentAge, maxAge) {
            const containerPC = document.getElementById('chartTabContainer');
            const containerMob = document.getElementById('chartTabContainerMobile');
            
            // å…±é€šã®HTMLãƒœã‚¿ãƒ³æ–‡å­—åˆ—ã‚’ä½œæˆ
            let html = `<button onclick="updateChartRange(${currentAge}, ${maxAge})" class="chart-period-btn active bg-blue-600 text-white text-[10px] px-3 h-7 flex-shrink-0 flex items-center justify-center rounded transition-colors whitespace-nowrap" data-min="${currentAge}" data-max="${maxAge}">å…¨æœŸé–“</button>`;
            
            for (let i = currentAge; i < maxAge; i += 10) {
                const end = Math.min(i + 9, maxAge);
                if (i >= maxAge) break;
                html += `<button onclick="updateChartRange(${i}, ${end})" class="chart-period-btn bg-slate-800 text-gray-400 hover:text-white text-[10px] px-3 h-7 flex-shrink-0 flex items-center justify-center rounded transition-colors whitespace-nowrap" data-min="${i}" data-max="${end}">${i}-${end}æ­³</button>`; 
            }
            
            if (containerPC) containerPC.innerHTML = html;
            if (containerMob) containerMob.innerHTML = html;
        }

        function updateChartRange(min, max) {
            // PCã¨ãƒ¢ãƒã‚¤ãƒ«ä¸¡æ–¹ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            [myChart, myChartMobile].forEach(chart => {
                if(!chart) return;
                chart.resetZoom();
                chart.options.scales.x.min = min;
                chart.options.scales.x.max = max;
                chart.update();
            });
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åŒæœŸ
            document.querySelectorAll('.chart-period-btn').forEach(b => {
                const bMin = +b.getAttribute('data-min');
                const bMax = +b.getAttribute('data-max');
                
                // ç¯„å›²ãŒä¸€è‡´ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                if (bMin === min && bMax === max) {
                    b.classList.remove('bg-slate-800', 'text-gray-400');
                    b.classList.add('bg-blue-600', 'text-white');
                } else {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-800', 'text-gray-400');
                }
            });
        }

        function calculate(skipMainChart = false) {
            updateTotalBar(); saveState();
            const assets = getActiveAssets();
            const age = +document.getElementById('currentAge').value || 35;
            const init = (+document.getElementById('initialAsset').value || 0) * 10000;
            const monthly = (+document.getElementById('monthlyAdd').value) * 10000;
            const target = (+document.getElementById('targetAsset').value) * 10000;
            const wAge = +document.getElementById('withdrawAge').value || 60;
            const wRate = +document.getElementById('num_withdrawRate').value / 100;
            const crashCount = +document.getElementById('crashCount').value;
            const protectDCA = document.getElementById('protectDCA').checked; // DCA mode
            
            // Current PF
            let retC=0, crashC=0, totalC=0, pfDataC=[];
            assets.forEach(a => { const v = +document.getElementById(`range_current_${a.key}`).value||0; totalC += v; if(v>0) pfDataC.push({name:a.name, val:v, color:a.color}); });
            assets.forEach(a => { if(totalC>0){ const w=+document.getElementById(`range_current_${a.key}`).value/totalC; retC+=a.ret*w; crashC+=a.crash*w; }});
            
            // Future PF
            let retF=0, crashF=0, totalF=0, pfDataF=[];
            assets.forEach(a => { const v = +document.getElementById(`range_future_${a.key}`).value||0; totalF += v; if(v>0) pfDataF.push({name:a.name, val:v, color:a.color}); });
            assets.forEach(a => { if(totalF>0){ const w=+document.getElementById(`range_future_${a.key}`).value/totalF; retF+=a.ret*w; crashF+=a.crash*w; }});

            // After PF
            let retA=0, crashA=0, totalA=0, pfDataA=[];
            assets.forEach(a => { const v = +document.getElementById(`range_after_${a.key}`).value||0; totalA += v; if(v>0) pfDataA.push({name:a.name, val:v, color:a.color}); });
            assets.forEach(a => { if(totalA>0){ const w=+document.getElementById(`range_after_${a.key}`).value/totalA; retA+=a.ret*w; crashA+=a.crash*w; }});

            document.getElementById('tabRetCurrent').innerText = (retC*100).toFixed(1);
            document.getElementById('tabRiskCurrent').innerText = totalC>0 ? (-(1-crashC)*100).toFixed(1) : '0.0';
            document.getElementById('tabRetFuture').innerText = (retF*100).toFixed(1);
            document.getElementById('tabRiskFuture').innerText = totalF>0 ? (-(1-crashF)*100).toFixed(1) : '0.0';
            document.getElementById('tabRetAfter').innerText = (retA*100).toFixed(1);
            document.getElementById('tabRiskAfter').innerText = totalA>0 ? (-(1-crashA)*100).toFixed(1) : '0.0';

            document.getElementById('specTotalRet').innerText = ((retC+retF)/2*100).toFixed(1);
            document.getElementById('specTotalCrash').innerText = (-(1-(crashC+crashF)/2)*100).toFixed(1);

            let hAge=[age], hPrin=[init/10000], hTotal=[init/10000], cA=init, cAcc=0, cP=init, peak=init, gAge=null, rAge=null;
            graduationIndex = null; 
            let isAchieved = false;

            // Check if initially achieved
            if (init >= target) {
                rAge = age;
                graduationIndex = 0;
                isAchieved = true;
            }

            if(crashCount>0) {
                const key = `${age}-${crashCount}-${document.getElementById('crashTimingMode').value}`;
                if(memoCrashKey!==key || !memoCrashYears.length) {
                    let arr = Array.from({length:100-age},(_,i)=>i+1);
                    const crashCapAge = 75;
                    const minDuration = 15; 
                    let validYears = crashCapAge - age;
                    if (validYears < minDuration) validYears = minDuration;
                    if (validYears > 100 - age) validYears = 100 - age;
                    arr = arr.slice(0, validYears);

                    if(document.getElementById('crashTimingMode').value==='random') {
                        arr.sort(()=>Math.random()-0.5);
                    }
                    else if(document.getElementById('crashTimingMode').value==='early') {
                        const boundary = Math.ceil(arr.length / 3);
                        arr = arr.slice(0, boundary);
                        arr.sort(()=>Math.random()-0.5); 
                    }
                    else if(document.getElementById('crashTimingMode').value==='middle') {
                        const start = Math.floor(arr.length / 3);
                        const end = Math.floor(arr.length * 2 / 3);
                        arr = arr.slice(start, end);
                        arr.sort(()=>Math.random()-0.5);
                    }
                    else { 
                        const start = Math.floor(arr.length * 2 / 3);
                        arr = arr.slice(start);
                        arr.sort(()=>Math.random()-0.5);
                    }
                    
                    memoCrashYears = arr.slice(0, crashCount); 
                    memoCrashKey=key;
                }
            } else { memoCrashYears=[]; memoCrashKey=''; }

            for(let i=1; i<=100-age; i++){
                const isCr = memoCrashYears.includes(i);
                
                let add = 0;
                if(age+i < wAge) {
                    if(!document.getElementById('coastFireMode').checked) {
                        add = monthly * 12;
                    } else if (!gAge) {
                        add = monthly * 12;
                    }
                }
                
                cP += add;

                // Determine rates based on achievement status
                // If achieved in previous step (or initially), use After rates
                const useAfterRates = isAchieved;
                const appliedRetC = useAfterRates ? retA : retC;
                const appliedCrashC = useAfterRates ? crashA : crashC;
                const appliedRetF = useAfterRates ? retA : retF;
                const appliedCrashF = useAfterRates ? crashA : crashF;

                if(age+i < wAge) { 
                    cA *= isCr ? appliedCrashC : (1+appliedRetC); 
                    
                    // Logic for accumulation part (cAcc)
                    if (isCr && protectDCA) {
                        // Protect this year's addition from crash
                        // Apply crash to existing accumulation, then add new funds safely
                        cAcc = (cAcc * appliedCrashF) + add;
                    } else {
                        // Standard logic: everything crashes or grows together
                        cAcc = (cAcc + add) * (isCr ? appliedCrashF : (1+appliedRetF));
                    }
                } else {
                    let tot = cA + cAcc; 
                    let wAmt = tot * wRate;
                    if(tot>0){ let r=wAmt/tot; if(r>1)r=1; cP-=cP*r; }
                    tot = Math.max(0, tot - wAmt);
                    
                    // Blended rates for withdrawal phase (though effectively same if achieved)
                    let blendedRet = (cA*appliedRetC + cAcc*appliedRetF) / (cA+cAcc||1);
                    let blendedCrash = (cA*appliedCrashC + cAcc*appliedCrashF) / (cA+cAcc||1);
                    
                    tot *= isCr ? blendedCrash : (1+blendedRet);
                    cA = tot * (cA/(cA+cAcc||1)); 
                    cAcc = tot - cA;
                }

                const now = cA + cAcc; 
                peak = Math.max(peak, now); 
                hAge.push(age+i); 
                hPrin.push(Math.round(cP/10000)); 
                hTotal.push(Math.round(now/10000));

                if(now >= target && !rAge) {
                    rAge = age + i;
                    graduationIndex = i; 
                    isAchieved = true; // Mark as achieved for NEXT iteration
                }
                if(document.getElementById('coastFireMode').checked && now >= target && !gAge) {
                    gAge = age + i;
                }
            }

            currentAnalysisContext = {
                profile: {
                    age: age,
                    initialAsset: init / 10000,
                    monthlyAdd: monthly / 10000,
                    targetAsset: target / 10000
                },
                result: {
                    peak: Math.round(peak/10000),
                    end: Math.round(hTotal[hTotal.length-1]/10000),
                    graduationAge: rAge,
                    isSuccess: !!rAge
                },
                portfolios: {
                    current: pfDataC.length > 0 ? pfDataC.map(p => `${p.name}: ${Math.round(p.val)}%`).join(', ') : 'è¨­å®šãªã—',
                    future: pfDataF.length > 0 ? pfDataF.map(p => `${p.name}: ${Math.round(p.val)}%`).join(', ') : 'è¨­å®šãªã—',
                    after: pfDataA.length > 0 ? pfDataA.map(p => `${p.name}: ${Math.round(p.val)}%`).join(', ') : 'è¨­å®šãªã—'
                },
                portfolio: pfDataF.map(p => `${p.name}: ${Math.round(p.val)}%`).join(', '),
                pfMetrics: {
                    c: { r: (retC*100).toFixed(1), k: (-(1-crashC)*100).toFixed(1) },
                    f: { r: (retF*100).toFixed(1), k: (-(1-crashF)*100).toFixed(1) },
                    a: { r: (retA*100).toFixed(1), k: (-(1-crashA)*100).toFixed(1) }
                }
            };

            document.getElementById('resPeakAsset').innerText = Math.round(peak/10000).toLocaleString();
            document.getElementById('resEndAsset').innerText = hTotal[hTotal.length-1].toLocaleString();
            
            if(document.getElementById('resPeakAssetMobile')) {
                document.getElementById('resPeakAssetMobile').innerText = Math.round(peak/10000).toLocaleString();
            }
            if(document.getElementById('resEndAssetMobile')) {
                document.getElementById('resEndAssetMobile').innerText = hTotal[hTotal.length-1].toLocaleString();
            }

            renderAchievement(rAge);
            
            if (!skipMainChart) {
                drawMainChart(hAge, hTotal, hPrin);
            }

            renderChartTabs(age, 100); 

            if (activeTab === 'current') updateSubCharts((retC*100).toFixed(1), (-(1-crashC)*100).toFixed(1), pfDataC);
            else if (activeTab === 'future') updateSubCharts((retF*100).toFixed(1), (-(1-crashF)*100).toFixed(1), pfDataF);
            else updateSubCharts((retA*100).toFixed(1), (-(1-crashA)*100).toFixed(1), pfDataA);
        }

        function switchTab(t) { 
            activeTab = t; 
            
            document.getElementById('tabCurrent').className = t==='current' ? 'flex-1 tab-btn tab-active' : 'flex-1 tab-btn tab-inactive';
            document.getElementById('tabFuture').className = t==='future' ? 'flex-1 tab-btn tab-active' : 'flex-1 tab-btn tab-inactive';
            document.getElementById('tabAfter').className = t==='after' ? 'flex-1 tab-btn tab-active' : 'flex-1 tab-btn tab-inactive';
            
            const scC = document.getElementById('containerSlidersCurrent');
            const scF = document.getElementById('containerSlidersFuture');
            const scA = document.getElementById('containerSlidersAfter');
            const icC = document.getElementById('containerInputsCurrent');
            const icF = document.getElementById('containerInputsFuture');
            const icA = document.getElementById('containerInputsAfter');

            scC.classList.add('hidden'); scF.classList.add('hidden'); scA.classList.add('hidden');
            icC.classList.add('hidden'); icF.classList.add('hidden'); icA.classList.add('hidden');

            if (t === 'current') { scC.classList.remove('hidden'); icC.classList.remove('hidden'); }
            else if (t === 'future') { scF.classList.remove('hidden'); icF.classList.remove('hidden'); }
            else { scA.classList.remove('hidden'); icA.classList.remove('hidden'); }

            const label1 = document.getElementById('chartLabelType');
            const label2 = document.getElementById('riskLabelType');
            const suffix = t==='current' ? '(ä»Šã®è³‡ç”£)' : (t==='future' ? '(ç©ç«‹)' : '(é”æˆå¾Œ)');
            if(label1) label1.innerText = suffix;
            if(label2) label2.innerText = suffix;

            if(inputMode === 'amount') { 
                const inpInit = document.getElementById('initialAsset');
                const inpMonth = document.getElementById('monthlyAdd');
                if(t === 'current') { inpInit.disabled = false; inpMonth.disabled = true; }
                else if (t === 'future') { inpInit.disabled = true; inpMonth.disabled = false; }
                else { inpInit.disabled = true; inpMonth.disabled = true; }
                syncPercentToAmounts(); 
            } else {
                const inpInit = document.getElementById('initialAsset');
                const inpMonth = document.getElementById('monthlyAdd');
                inpInit.disabled = false;
                inpMonth.disabled = false;
            }

            updateTotalBar(); 
            calculate(true); 
        }

        const targetLinePlugin = {
            id: 'targetLine',
            afterDatasetsDraw(chart, args, options) {
                if (graduationIndex === null) return;
                const { ctx, chartArea: { top, bottom }, scales: { x, y } } = chart;
                const meta = chart.getDatasetMeta(0);
                if (!meta.data[graduationIndex]) return; 
                const xPos = meta.data[graduationIndex].x;
                ctx.save();
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#facc15'; 
                ctx.setLineDash([6, 4]);
                ctx.moveTo(xPos, top);
                ctx.lineTo(xPos, bottom);
                ctx.stroke();
                ctx.fillStyle = '#facc15';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'left';
                const label = `ğŸš© ${chart.data.labels[graduationIndex]}æ­³ã§é”æˆ`;
                const textWidth = ctx.measureText(label).width;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(xPos + 4, top + 10, textWidth + 10, 20);
                ctx.fillStyle = '#facc15';
                ctx.fillText(label, xPos + 9, top + 24);
                ctx.restore();
            }
        };

        function drawMainChart(labels, dTotal, dPrin) {
            const age = +document.getElementById('currentAge').value || 35;
            const initialMaxAge = Math.max(80, age + 5);

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label:'å…ƒæœ¬', 
                            data:dPrin, 
                            borderColor:'#94a3b8', 
                            backgroundColor:'#94a3b8', 
                            fill:false, 
                            pointRadius:0, 
                            pointHoverRadius: 8, 
                            pointHitRadius: 20,  
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 2,
                            borderWidth:2, 
                            order:1 
                        },
                        { 
                            label:'è³‡ç”£ç·é¡', 
                            data:dTotal, 
                            borderColor:'#3b82f6', 
                            backgroundColor:'#3b82f6', 
                            fill:false, 
                            pointRadius:0, 
                            pointHoverRadius: 8, 
                            pointHitRadius: 20, 
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 2,
                            borderWidth:2, 
                            order:0 
                        },
                        { 
                            label:'æ¯”è¼ƒ', 
                            data:lockedData || [], 
                            borderColor:'rgba(255,255,255,0.5)', 
                            borderDash:[5,5], 
                            pointRadius:0, 
                            pointHoverRadius: 6,
                            fill:false, 
                            order:2, 
                            hidden:!lockedData 
                        }
                    ]
                },
                plugins: [targetLinePlugin],
                options: { 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins:{ 
                        legend:{labels:{color:'#94a3b8'}}, 
                        datalabels: { display: false },
                        tooltip: {
                            mode: 'index', intersect: false, backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                            titleColor: '#e2e8f0', bodyColor: '#cbd5e1', 
                            borderColor: 'rgba(148, 163, 184, 0.3)', borderWidth: 1, padding: 10,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) { 
                                    return ' ' + context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡'; 
                                },
                                footer: function(tooltipItems) {
                                    let total = 0, principal = 0;
                                    tooltipItems.forEach(function(item) {
                                        if (item.dataset.label === 'è³‡ç”£ç·é¡') total = item.raw;
                                        if (item.dataset.label === 'å…ƒæœ¬') principal = item.raw;
                                    });
                                    const profit = total - principal;
                                    const sign = profit > 0 ? '+' : '';
                                    return '\n å«ã¿ç›Š: ' + sign + profit.toLocaleString() + 'ä¸‡';
                                }
                            }
                        },
                        zoom: { 
                            pan: {
                                enabled: true,
                                mode: 'x', 
                                threshold: 0, 
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, 
                                    speed: 0.15, 
                                },
                                pinch: {
                                    enabled: true 
                                },
                                mode: 'x', 
                            },
                            limits: {
                                x: { min: age - 5, max: age + 100 + 5 },
                                y: { min: 0, max: 'original' } 
                            }
                        }
                    }, 
                    scales:{
                        x:{
                            grid:{display:false},
                            ticks:{color:'#64748b'},
                            min: age,             
                            max: initialMaxAge 
                        }, 
                        y:{
                            beginAtZero: true, 
                            stacked:false, 
                            grid:{color:'#1e293b'},
                            ticks:{color:'#64748b'}
                        }
                    }, 
                }
            };

            const canvasPC = document.getElementById('chartCanvas');
            if(canvasPC) {
                const ctx = canvasPC.getContext('2d');
                if(myChart) myChart.destroy();
                myChart = new Chart(ctx, config);
            }

            const canvasMob = document.getElementById('chartCanvasMobile');
            if(canvasMob) {
                const ctxMob = canvasMob.getContext('2d');
                if(myChartMobile) myChartMobile.destroy();
                
                const configMob = {
                    type: config.type,
                    data: {
                        labels: config.data.labels,
                        datasets: config.data.datasets.map(d => ({...d}))
                    },
                    plugins: [targetLinePlugin],
                    options: JSON.parse(JSON.stringify(config.options))
                };
                
                configMob.options.plugins.tooltip.callbacks = config.options.plugins.tooltip.callbacks;

                myChartMobile = new Chart(ctxMob, configMob);
            }
        }

        function getSettingsFromUI() {
            const data = {
                currentAge: document.getElementById('currentAge').value,
                initialAsset: document.getElementById('initialAsset').value,
                monthlyAdd: document.getElementById('monthlyAdd').value,
                targetAsset: document.getElementById('targetAsset').value,
                coastFireMode: document.getElementById('coastFireMode').checked,
                protectDCA: document.getElementById('protectDCA').checked,
                withdrawAge: document.getElementById('withdrawAge').value,
                crashCount: document.getElementById('crashCount').value,
                num_withdrawRate: document.getElementById('num_withdrawRate').value,
                crashTimingMode: document.getElementById('crashTimingMode').value,
                visibleAssets: visibleAssets,
                inputMode: inputMode,
                activeTab: activeTab,
                lockedData: lockedData,
                assets: {}
            };
            ASSETS_DEF.forEach(a => {
                data.assets[a.key] = {
                    current: document.getElementById(`range_current_${a.key}`)?.value || 0,
                    future: document.getElementById(`range_future_${a.key}`)?.value || 0,
                    after: document.getElementById(`range_after_${a.key}`)?.value || 0,
                    amtCurrent: document.getElementById(`amt_current_${a.key}`)?.value || 0,
                    amtFuture: document.getElementById(`amt_future_${a.key}`)?.value || 0
                };
            });
            return data;
        }

        function applySettingsToUI(data) {
            if(!data) return;
            if(data.currentAge) document.getElementById('currentAge').value = data.currentAge;
            if(data.initialAsset) document.getElementById('initialAsset').value = data.initialAsset;
            if(data.monthlyAdd) document.getElementById('monthlyAdd').value = data.monthlyAdd;
            if(data.targetAsset) document.getElementById('targetAsset').value = data.targetAsset;
            if(data.coastFireMode !== undefined) document.getElementById('coastFireMode').checked = data.coastFireMode;
            if(data.protectDCA !== undefined) document.getElementById('protectDCA').checked = data.protectDCA;
            if(data.withdrawAge) document.getElementById('withdrawAge').value = data.withdrawAge;
            if(data.crashCount) document.getElementById('crashCount').value = data.crashCount;
            if(data.num_withdrawRate) document.getElementById('num_withdrawRate').value = data.num_withdrawRate;
            if(data.crashTimingMode) document.getElementById('crashTimingMode').value = data.crashTimingMode;
            
            if(data.visibleAssets) {
                visibleAssets = data.visibleAssets;
                renderUI(); 
            }
            if(data.lockedData) lockedData = data.lockedData;
            
            if(data.assets) {
                ASSETS_DEF.forEach(a => {
                    if(data.assets[a.key]) {
                        const d = data.assets[a.key];
                        const elC = document.getElementById(`range_current_${a.key}`);
                        const elNumC = document.getElementById(`num_current_${a.key}`);
                        const elF = document.getElementById(`range_future_${a.key}`);
                        const elNumF = document.getElementById(`num_future_${a.key}`);
                        const elA = document.getElementById(`range_after_${a.key}`);
                        const elNumA = document.getElementById(`num_after_${a.key}`);
                        
                        if(elC) elC.value = d.current;
                        if(elNumC) elNumC.value = d.current;
                        if(elF) elF.value = d.future;
                        if(elNumF) elNumF.value = d.future;
                        if(elA) elA.value = d.after !== undefined ? d.after : d.future; 
                        if(elNumA) elNumA.value = d.after !== undefined ? d.after : d.future;
                        
                        const amtC = document.getElementById(`amt_current_${a.key}`);
                        const amtF = document.getElementById(`amt_future_${a.key}`);
                        if(amtC && d.amtCurrent !== undefined) amtC.value = d.amtCurrent;
                        if(amtF && d.amtFuture !== undefined) amtF.value = d.amtFuture;
                    }
                });
            }

            if(data.inputMode) {
                inputMode = data.inputMode;
                setInputMode(inputMode);
            }
            if(data.activeTab) {
                activeTab = data.activeTab;
                switchTab(activeTab);
            }

            if (inputMode === 'amount') {
                syncAmountsToPercent();
            } else {
                syncPercentToAmounts();
            }
        }

        function updateSubCharts(retVal, crashVal, pfData) {
            const ctxPf = document.getElementById('portfolioChart').getContext('2d');
            const ctxRr = document.getElementById('riskReturnChart').getContext('2d');
            if(pfChart) pfChart.destroy();
            pfChart = new Chart(ctxPf, { type: 'doughnut', plugins: [ChartDataLabels], data: { labels: pfData.map(d=>d.name), datasets: [{ data: pfData.map(d=>d.val), backgroundColor: pfData.map(d=>d.color), borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex] + '\n' + Math.round(val) + '%', anchor: 'center', align: 'center' } }, cutout:'50%' } });
            if(rrChart) rrChart.destroy();
            rrChart = new Chart(ctxRr, { type: 'bar', plugins: [ChartDataLabels], data: { labels: ['æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³', 'æœ€å¤§ãƒªã‚¹ã‚¯'], datasets: [{ data: [parseFloat(retVal), parseFloat(crashVal)], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 4, maxBarThickness: 40 }] }, options: { responsive:true, maintainAspectRatio:false, layout: { padding: { top: 40 } }, indexAxis: 'x', plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (val) => val > 0 ? '+' + val + '%' : val + '%', anchor: 'end', align: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0 ? 'top' : 'bottom' } }, scales:{ x:{ grid:{display:false}, ticks:{color:'#94a3b8', font:{size:10}} }, y:{ grid:{color:'#334155'}, ticks:{color:'#64748b'}, beginAtZero:true } } } });
        }

        function lockComparison() { if(myChart) { lockedData = [...myChart.data.datasets[1].data]; alert('å›ºå®šã—ã¾ã—ãŸ'); calculate(false); } }
        function unlockComparison() { lockedData = null; alert('å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ'); calculate(false); }
        function renderAchievement(age) { document.getElementById('achievementMobile').innerHTML = age ? `<div class="bg-yellow-600/80 p-2 rounded text-white font-bold mb-2">ğŸ‰ ${age}æ­³ã§é”æˆï¼</div>` : `<div class="bg-slate-800 p-2 rounded text-gray-400 mb-2">æœªé”...</div>`; document.getElementById('achievementDesktop').innerHTML = document.getElementById('achievementMobile').innerHTML; }
        function saveState() { 
            const data = getSettingsFromUI();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
        } 
        function loadState() { 
            try { 
                const s = JSON.parse(localStorage.getItem(STORAGE_KEY)); 
                if(s) applySettingsToUI(s);
            } catch(e) { console.error(e); } 
        }
        function exportSettings() { 
            const data = getSettingsFromUI(); 
            const blob = new Blob([JSON.stringify(data)],{type:'application/json'}); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `fire_sim_data_${getFormattedDate()}.json`; 
            a.click(); 
        }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importSettings(e) { 
            const r = new FileReader(); 
            r.onload = function(e){
                try {
                    const data = JSON.parse(e.target.result);
                    applySettingsToUI(data); 
                    calculate(false); 
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch(err) { alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); }
            }; 
            r.readAsText(e.files[0]); 
        }

        // --- Utils: Date ---
        function getFormattedDate() {
            const now = new Date();
            const y = now.getFullYear();
            const m = ('0' + (now.getMonth() + 1)).slice(-2);
            const d = ('0' + now.getDate()).slice(-2);
            const h = ('0' + now.getHours()).slice(-2);
            const min = ('0' + now.getMinutes()).slice(-2);
            return `${y}${m}${d}_${h}${min}`;
        }

        // --- Features: Share & Copy ---
        function shareToX() {
            const peak = document.getElementById('resPeakAsset').innerText;
            const end = document.getElementById('resEndAsset').innerText;
            const text = `FIRE Simulatorã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã—ãŸï¼\nè³‡ç”£ãƒ”ãƒ¼ã‚¯: ${peak}ä¸‡å††\n100æ­³æ™‚ç‚¹: ${end}ä¸‡å††\n#FIRESimulator`;
            const url = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text);
            window.open(url, '_blank');
        }

        function copyResult() {
            const peak = document.getElementById('resPeakAsset').innerText;
            const end = document.getElementById('resEndAsset').innerText;
            const text = `è³‡ç”£ãƒ”ãƒ¼ã‚¯: ${peak}ä¸‡å††\n100æ­³æ™‚ç‚¹: ${end}ä¸‡å††`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(err => alert('ã‚³ãƒ”ãƒ¼å¤±æ•—'));
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                } catch (err) {
                    alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                document.body.removeChild(ta);
            }
        }

        function downloadChart() { 
            const canvas = document.getElementById('chartCanvas');
            if (!canvas) {
                alert('ã‚°ãƒ©ãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                
                ctx.fillStyle = '#0b0f19'; 
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, 0, 0);

                const url = tempCanvas.toDataURL('image/png');
                
                const a = document.createElement('a'); 
                a.href = url;
                a.download = `chart_${getFormattedDate()}.png`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a);
            } catch (e) {
                console.error(e);
                alert('ç”»åƒä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        }
        function rerollCrash() { memoCrashYears=[]; calculate(false); }

        // --- New Prompt Generation Logic ---
        function openPromptModal() {
            const ctx = currentAnalysisContext;
            if(!ctx || !ctx.profile) { alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }

            const statusText = ctx.result.isSuccess ? 
                `${ctx.result.graduationAge}æ­³ã§FIREé”æˆå¯èƒ½ã§ã™ã€‚` : 
                "ç¾æ™‚ç‚¹ã§ã¯ç›®æ¨™é‡‘é¡ã«å±Šã‹ãªã„è¦‹è¾¼ã¿ã§ã™ã€‚";

            const timingText = document.getElementById('crashTimingMode').options[document.getElementById('crashTimingMode').selectedIndex].text;

            const pfSection = `ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªé…åˆ†ã€‘
â–  ç¾åœ¨ã®è³‡ç”£
${ctx.portfolios.current}
(å¹´åˆ©${ctx.pfMetrics.c.r}% / ãƒªã‚¹ã‚¯${ctx.pfMetrics.c.k}%)

â–  ç©ç«‹æŠ•è³‡
${ctx.portfolios.future}
(å¹´åˆ©${ctx.pfMetrics.f.r}% / ãƒªã‚¹ã‚¯${ctx.pfMetrics.f.k}%)

â–  é”æˆå¾Œ/å–å´©ã—
${ctx.portfolios.after}
(å¹´åˆ©${ctx.pfMetrics.a.r}% / ãƒªã‚¹ã‚¯${ctx.pfMetrics.a.k}%)`;

            const prompt = `ä»¥ä¸‹ã®FIREã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ã‚‚ã¨ã«ã€ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚
ç‰¹ã«ãƒªã‚¹ã‚¯ç®¡ç†ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®æ”¹å–„ç‚¹ã€ç›®æ¨™é”æˆã«å‘ã‘ãŸå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
- å¹´é½¢: ${ctx.profile.age}æ­³
- ç¾åœ¨è³‡ç”£: ${ctx.profile.initialAsset}ä¸‡å††
- æ¯æœˆç©ç«‹: ${ctx.profile.monthlyAdd}ä¸‡å††
- ç›®æ¨™é‡‘é¡: ${ctx.profile.targetAsset}ä¸‡å††
- æš´è½è¨­å®š: ${document.getElementById('crashCount').value}å› (${timingText})

${pfSection}

ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã€‘
- åˆ¤å®š: ${statusText}
- è³‡ç”£ãƒ”ãƒ¼ã‚¯: ${ctx.result.peak}ä¸‡å††
- 100æ­³æ™‚ç‚¹: ${ctx.result.end}ä¸‡å††

ã€ç›¸è«‡ã—ãŸã„ã“ã¨ã€‘
ã“ã®ãƒ—ãƒ©ãƒ³ã®å®Ÿç¾å¯èƒ½æ€§ã¯ã©ã®ç¨‹åº¦ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã¾ãŸã€ã‚ˆã‚Šå®‰å…¨ã«ã€ã‚ã‚‹ã„ã¯ã‚ˆã‚Šæ—©ãç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã®æ”¹å–„æ¡ˆã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`;

            document.getElementById('promptTextarea').value = prompt;
            document.getElementById('promptModal').style.display = 'flex';
        }

        function closePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
            document.getElementById('copyBtnLabel').innerText = 'ã‚³ãƒ”ãƒ¼ã™ã‚‹';
        }

        function copyPromptText() {
            const ta = document.getElementById('promptTextarea');
            ta.select();
            document.execCommand('copy');
            document.getElementById('copyBtnLabel').innerText = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
            setTimeout(() => {
                document.getElementById('copyBtnLabel').innerText = 'ã‚³ãƒ”ãƒ¼ã™ã‚‹';
            }, 2000);
        }

        function renderChartTabs(currentAge, maxAge) {
            const containerPC = document.getElementById('chartTabContainer');
            const containerMob = document.getElementById('chartTabContainerMobile');
            
            // å…±é€šã®HTMLãƒœã‚¿ãƒ³æ–‡å­—åˆ—ã‚’ä½œæˆ
            let html = `<button onclick="updateChartRange(${currentAge}, ${maxAge})" class="chart-period-btn active bg-blue-600 text-white text-[10px] px-3 h-7 flex-shrink-0 flex items-center justify-center rounded transition-colors whitespace-nowrap" data-min="${currentAge}" data-max="${maxAge}">å…¨æœŸé–“</button>`;
            
            for (let i = currentAge; i < maxAge; i += 10) {
                const end = Math.min(i + 9, maxAge);
                if (i >= maxAge) break;
                html += `<button onclick="updateChartRange(${i}, ${end})" class="chart-period-btn bg-slate-800 text-gray-400 hover:text-white text-[10px] px-3 h-7 flex-shrink-0 flex items-center justify-center rounded transition-colors whitespace-nowrap" data-min="${i}" data-max="${end}">${i}-${end}æ­³</button>`; 
            }
            
            if (containerPC) containerPC.innerHTML = html;
            if (containerMob) containerMob.innerHTML = html;
        }

        function updateChartRange(min, max) {
            // PCã¨ãƒ¢ãƒã‚¤ãƒ«ä¸¡æ–¹ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            [myChart, myChartMobile].forEach(chart => {
                if(!chart) return;
                chart.resetZoom();
                chart.options.scales.x.min = min;
                chart.options.scales.x.max = max;
                chart.update();
            });
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åŒæœŸ
            document.querySelectorAll('.chart-period-btn').forEach(b => {
                const bMin = +b.getAttribute('data-min');
                const bMax = +b.getAttribute('data-max');
                
                // ç¯„å›²ãŒä¸€è‡´ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                if (bMin === min && bMax === max) {
                    b.classList.remove('bg-slate-800', 'text-gray-400');
                    b.classList.add('bg-blue-600', 'text-white');
                } else {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-800', 'text-gray-400');
                }
            });
        }
        
        function resetChartZoom() {
            // ç¾åœ¨ã®å¹´é½¢æƒ…å ±ãªã©ã‚’å–å¾—ã—ã¦å…¨æœŸé–“ãƒªã‚»ãƒƒãƒˆï¼ˆåˆæœŸçŠ¶æ…‹ã¨åŒã˜ã«ã™ã‚‹ï¼‰
            // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ï¼ˆå…¨æœŸé–“ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å®Ÿè¡Œã™ã‚‹ã®ãŒç¢ºå®Ÿ
            const allBtn = document.querySelector('.chart-period-btn');
            if(allBtn) {
                const min = +allBtn.getAttribute('data-min');
                const max = +allBtn.getAttribute('data-max');
                updateChartRange(min, max);
            }
        }

    </script>
</body>
</html>
