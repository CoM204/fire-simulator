<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE Simulator v6.8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0b0f19; color: #e2e8f0; font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 20%); background-attachment: fixed; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.2); color: #f8fafc; border-radius: 8px; font-family: 'Inter', sans-serif; transition: all 0.3s; }
        .glass-input:focus { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); outline: none; background: rgba(15, 23, 42, 0.9); }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 20px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; border-radius: 2px; background: rgba(148, 163, 184, 0.2); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #60a5fa; margin-top: -6px; box-shadow: 0 0 10px rgba(96, 165, 250, 0.5); border: 2px solid #1e293b; transition: transform 0.1s; }
        .tab-btn { transition: all 0.3s; position: relative; overflow: hidden; }
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .tab-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; border: 1px solid rgba(255,255,255,0.05); }
        .text-glow { text-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
        .text-glow-red { text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }
        .text-glow-gold { text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .sticky-result { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(11, 15, 25, 0.9); backdrop-filter: blur(16px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 12px; z-index: 50; }
        #chartModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #chartModal canvas { background: #0f172a; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 100% !important; height: auto !important; max-height: 70vh; }
        .num-input-small { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 4px; padding: 2px 6px; width: 45px; text-align: right; font-size: 11px; font-weight: bold; }
        .achievement-badge { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        @media (min-width: 1024px) {
            .container-grid { display: grid; grid-template-columns: 350px 1fr; gap: 24px; max-width: 1200px; margin: 0 auto; align-items: start; }
            .chart-area { position: sticky; top: 20px; }
            .sticky-result { position: static !important; background: transparent !important; border: none !important; backdrop-filter: none !important; padding: 0 !important; margin-top: 20px; }
            .sticky-result .grid { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px; }
            .sub-charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>
</head>
<body class="p-4">

    <header class="mb-6 text-center lg:text-left lg:max-w-[1200px] lg:mx-auto">
        <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 tracking-tight">FIRE Simulator <span class="text-xs text-gray-500 font-normal align-middle ml-1">v6.8</span></h1>
    </header>

    <div class="container-grid">
        <div class="input-column">
            <div id="achievementMobile" class="lg:hidden mb-4"></div>

            <div class="glass-card p-4 mb-5">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-blue-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-blue-300 tracking-wider">PROFILE</h2></div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨ã®å¹´é½¢</label><div class="relative"><input type="number" id="currentAge" value="35" oninput="calculate()" class="glass-input w-full p-2 text-center text-sm font-bold"><span class="absolute right-3 top-2 text-[10px] text-gray-500">æ­³</span></div></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç¾åœ¨è³‡ç”£</label><div class="relative"><input type="number" id="initialAsset" value="1000" oninput="calculate()" class="glass-input w-full p-2 text-center text-sm font-bold"><span class="absolute right-3 top-2 text-[10px] text-gray-500">ä¸‡</span></div></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">æ¯æœˆç©ç«‹</label><div class="relative"><input type="number" id="monthlyAdd" value="10" oninput="calculate()" class="glass-input w-full p-2 text-center text-sm font-bold"><span class="absolute right-3 top-2 text-[10px] text-gray-500">ä¸‡</span></div></div>
                    <div><label class="text-[10px] text-yellow-500/80 block mb-1 font-bold">ç›®æ¨™é‡‘é¡</label><div class="relative"><input type="number" id="targetAsset" value="3000" step="100" oninput="calculate()" class="glass-input w-full p-2 text-center text-sm font-bold border-yellow-500/30 text-yellow-100"><span class="absolute right-3 top-2 text-[10px] text-gray-500">ä¸‡</span></div></div>
                </div>
                <div class="bg-blue-900/20 p-2 rounded-lg border border-blue-500/20 flex items-center justify-between">
                    <div class="flex items-center gap-2"><input type="checkbox" id="coastFireMode" onchange="calculate()" class="w-4 h-4 text-blue-500 rounded bg-slate-800 border-slate-600"><label for="coastFireMode" class="text-[10px] font-bold text-blue-200 cursor-pointer">ç›®æ¨™é”æˆã§ç©ç«‹åœæ­¢</label></div>
                    <div id="graduationAgeArea" class="hidden"><span class="bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 px-2 py-0.5 rounded text-[10px] font-bold">ğŸ‰ <span id="graduationAge">0</span>æ­³ã§å’æ¥­</span></div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-orange-500/20 bg-orange-900/10">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center"><div class="w-1 h-4 bg-orange-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-orange-300 tracking-wider">ACTUAL HISTORY</h2></div>
                    <div id="gapDisplay" class="text-xs font-bold text-gray-400"></div>
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="histAge" placeholder="å¹´é½¢" class="glass-input w-1/3 p-2 text-center text-xs font-bold">
                    <input type="number" id="histAsset" placeholder="è³‡ç”£(ä¸‡)" class="glass-input w-full p-2 text-center text-xs font-bold">
                    <button onclick="addHistory()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 rounded font-bold text-xs">è¿½åŠ </button>
                </div>
                <div id="historyList" class="bg-slate-900/50 rounded-lg max-h-[100px] overflow-y-auto p-2 border border-slate-700/50">
                    <div class="text-center text-[10px] text-gray-500 py-2">å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5">
                <div class="flex items-center mb-4"><div class="w-1 h-4 bg-purple-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-purple-300 tracking-wider">PORTFOLIO</h2></div>
                <div class="flex gap-2 mb-4">
                    <button id="tabCurrent" onclick="switchTab('current')" class="flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-active">ä»Šã®è³‡ç”£</button>
                    <button id="tabFuture" onclick="switchTab('future')" class="flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-inactive">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</button>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-5">
                    <button onclick="applyPreset('defensive')" class="bg-emerald-900/30 border border-emerald-500/30 text-emerald-400 text-[10px] py-2 rounded hover:bg-emerald-900/50">ğŸ›¡ï¸ é‰„å£</button>
                    <button onclick="applyPreset('standard')" class="bg-blue-900/30 border border-blue-500/30 text-blue-400 text-[10px] py-2 rounded hover:bg-blue-900/50">ğŸ‘‘ ç‹é“</button>
                    <button onclick="applyPreset('aggressive')" class="bg-purple-900/30 border border-purple-500/30 text-purple-400 text-[10px] py-2 rounded hover:bg-purple-900/50">ğŸš€ çˆ†ç›Š</button>
                </div>
                <div class="mb-5 bg-slate-800/50 rounded-full h-4 relative overflow-hidden border border-slate-700/50"><div id="totalProgressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 100%"></div></div>
                <div id="containerCurrent" class="block"><div id="slidersCurrent" class="grid grid-cols-2 gap-3"></div></div>
                <div id="containerFuture" class="hidden"><div id="slidersFuture" class="grid grid-cols-2 gap-3"></div></div>
                <div class="mt-5 glass-card p-3 border-indigo-500/30">
                    <div class="flex justify-center items-center gap-4 text-center">
                        <div>
                            <p class="text-[9px] text-gray-400 mb-0.5">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</p>
                            <p class="text-lg font-black text-white text-glow"><span id="specTotalRet">0.0</span><span class="text-xs ml-0.5">%</span></p>
                        </div>
                        <div class="h-6 w-px bg-slate-600"></div>
                        <div>
                            <p class="text-[9px] text-red-400/80 mb-0.5">æœ€å¤§ãƒªã‚¹ã‚¯</p>
                            <p class="text-lg font-black text-red-500 text-glow-red"><span id="specTotalCrash">0.0</span><span class="text-xs ml-0.5">%</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-indigo-500/20 bg-indigo-900/10">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-indigo-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-indigo-300 tracking-wider">EXIT STRATEGY</h2></div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-gray-400 block mb-1">é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawAge" value="60" oninput="calculate()" class="glass-input w-full p-2 text-center text-sm font-bold"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">æ–¹æ³•</label><select id="withdrawType" onchange="calculate()" class="glass-input w-full p-2 text-center text-xs font-bold h-[38px]"><option value="rate">å®šç‡ (ï¼…)</option><option value="amount">å®šé¡ (ä¸‡å††)</option></select></div>
                </div>
                <div id="inputRateArea" class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-indigo-300">æ¯å¹´å¼•ãå‡ºã™å‰²åˆ (%)</label><input type="number" id="num_withdrawRate" value="4.0" step="0.1" oninput="syncRange('withdrawRateRange', this.value)" class="num-input-small"></div>
                    <input type="range" id="withdrawRateRange" min="0" max="10" step="0.1" value="4.0" class="w-full" oninput="syncNum('num_withdrawRate', this.value)">
                </div>
                <div id="inputAmountArea" class="hidden bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-indigo-300">æ¯æœˆå¼•ãå‡ºã™é‡‘é¡ (ä¸‡)</label><input type="number" id="num_withdrawAmt" value="20" oninput="syncRange('withdrawAmountRange', this.value)" class="num-input-small"></div>
                    <input type="range" id="withdrawAmountRange" min="0" max="100" step="1" value="20" class="w-full" oninput="syncNum('num_withdrawAmt', this.value)">
                </div>
            </div>

            <div class="glass-card p-4 mb-5 border-red-500/20 bg-red-900/10">
                <div class="flex items-center mb-3"><div class="w-1 h-4 bg-red-500 rounded-full mr-2"></div><h2 class="text-xs font-bold text-red-300 tracking-wider">MARKET CRASH</h2></div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="crashCount" onchange="calculate()" class="glass-input w-full p-2 text-xs font-bold text-center"><option value="0">æš´è½ãªã—</option><option value="2">2å›ç™ºç”Ÿ</option><option value="5" selected>5å›ç™ºç”Ÿ</option><option value="8">8å›ç™ºç”Ÿ</option></select>
                    <div class="flex gap-1"><select id="crashTimingMode" onchange="calculate()" class="glass-input w-full p-2 text-xs font-bold text-center flex-1"><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option><option value="early">åºç›¤é›†ä¸­</option><option value="late">çµ‚ç›¤é›†ä¸­</option></select><button onclick="rerollCrash()" class="glass-input px-3 text-lg hover:bg-slate-700 transition">ğŸ²</button></div>
                </div>
            </div>

            <div class="glass-card p-3 mb-5 border-slate-500/30">
                <div class="flex items-center mb-2"><div class="w-1 h-4 bg-slate-400 rounded-full mr-2"></div><h2 class="text-xs font-bold text-slate-300 tracking-wider">DATA & COMPARE</h2></div>
                <button onclick="lockComparison()" class="w-full bg-indigo-600/80 hover:bg-indigo-500 text-white text-[10px] font-bold py-2 rounded border border-indigo-400/50 mb-2 transition shadow-lg flex justify-center items-center gap-1">ğŸ“Œ ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒç”¨ã«å›ºå®š</button>
                <div class="flex gap-2">
                    <button onclick="exportSettings()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold py-2 rounded border border-slate-500/50 transition">ğŸ’¾ ä¿å­˜</button>
                    <button onclick="triggerImport()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold py-2 rounded border border-slate-500/50 transition">ğŸ“‚ èª­è¾¼</button>
                    <input type="file" id="importFile" style="display: none;" onchange="importSettings(this)">
                </div>
            </div>
            
            <div class="space-y-3 mb-10 lg:mb-0">
                <a href="https://www.a8.net/" target="_blank" class="block bg-gradient-to-r from-blue-700 to-blue-600 p-3 rounded-lg text-center text-white shadow-lg border border-blue-400/20 font-bold text-xs hover:opacity-90 transition">SBIè¨¼åˆ¸ å£åº§é–‹è¨­ã¯ã“ã¡ã‚‰ï¼ˆPRï¼‰</a>
                <a href="https://www.a8.net/" target="_blank" class="block bg-gradient-to-r from-emerald-700 to-emerald-600 p-3 rounded-lg text-center text-white shadow-lg border border-emerald-400/20 font-bold text-xs hover:opacity-90 transition">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ï¼ˆNLï¼‰ã‚’ä½œã‚‹ï¼ˆPRï¼‰</a>
            </div>
        </div>

        <div class="result-column chart-area">
            <div id="achievementDesktop" class="hidden lg:block mb-6"></div>

            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[9px] text-gray-500 font-bold">SIMULATION CHART</span>
                <div class="flex gap-2">
                    <button onclick="downloadChart()" class="bg-slate-800/80 border border-slate-600/50 px-2 py-1 rounded text-[9px] font-bold text-gray-300 hover:bg-slate-700 flex items-center gap-1">ğŸ“¥ ä¿å­˜</button>
                    <button onclick="shareViaEmail()" class="bg-blue-900/40 border border-blue-500/30 px-2 py-1 rounded text-[9px] font-bold text-blue-200 hover:bg-blue-900/60 flex items-center gap-1">âœ‰ï¸ å…±æœ‰</button>
                </div>
            </div>
            <div class="glass-card p-2 mb-5 cursor-zoom-in relative h-[320px] lg:h-[400px] transition hover:border-slate-500/50" onclick="openChartModal()">
                <canvas id="chartCanvas"></canvas>
            </div>

            <div class="sub-charts-grid mb-5">
                <div class="glass-card p-4 relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-2 text-center">ASSET ALLOCATION</p>
                    <div class="relative h-[150px] flex justify-center"><canvas id="portfolioChart"></canvas></div>
                </div>
                <div class="glass-card p-4 relative">
                    <p class="text-[10px] text-gray-400 font-bold mb-2 text-center">RISK / RETURN MAP</p>
                    <div class="relative h-[150px]"><canvas id="riskReturnChart"></canvas></div>
                </div>
            </div>

            <div class="sticky-result">
                <div class="max-w-md mx-auto lg:max-w-none grid grid-cols-2 gap-4 text-center">
                    <div><p class="text-[9px] text-gray-500 font-bold mb-0.5">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p><p class="text-xl font-black text-yellow-400 text-glow"><span id="resPeakAsset">0</span><span class="text-xs text-gray-500 ml-1 font-normal">ä¸‡</span></p></div>
                    <div class="border-l border-slate-700 pl-4"><p class="text-[9px] text-gray-500 font-bold mb-0.5">100æ­³æ™‚ç‚¹</p><p class="text-base font-bold text-gray-200"><span id="resEndAsset">0</span><span class="text-xs text-gray-500 ml-1 font-normal">ä¸‡</span></p></div>
                </div>
            </div>

            <footer class="text-center text-[10px] text-gray-600 border-t border-slate-800 pt-6 pb-20 lg:pb-6">
                <div class="flex justify-center gap-4 mb-2"><a href="privacy.html" class="hover:text-gray-400">é‹å–¶è€…æƒ…å ±</a><a href="privacy.html" class="hover:text-gray-400">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></div>
                <p>&copy; 2026 simulator8</p>
            </footer>
        </div>
    </div>

    <div id="chartModal"><div class="w-full max-w-lg flex justify-between items-center mb-4 px-2"><span class="text-[10px] text-gray-400 font-bold tracking-widest">FULL SCREEN CHART</span><button onclick="closeChartModal()" class="bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-500/30">âœ• é–‰ã˜ã‚‹</button></div><canvas id="modalChartCanvas" onclick="event.stopPropagation()"></canvas></div>

    <script>
        const STORAGE_KEY = 'simulatorState_v37';
        const ASSETS = [
            { key: 'cash', name: 'ğŸ’´ ç¾é‡‘', cat:'cash', desc: 'æ—¥æœ¬å††', ret: 0.00, crash: 1.00, color: '#64748b', defC: 50, defF: 0 },
            { key: 'bond', name: 'ğŸ“œ å‚µåˆ¸', cat:'bond', desc: 'ç±³å›½å‚µç­‰', ret: 0.03, crash: 0.95, color: '#2dd4bf', defC: 0, defF: 0 },
            { key: 'gold', name: 'ğŸ¥‡ é‡‘',   cat:'gold', desc: 'å®‰å…¨è³‡ç”£', ret: 0.04, crash: 0.85, color: '#fbbf24', defC: 0, defF: 0 },
            { key: 'reit', name: 'ğŸ¢ ä¸å‹•ç”£', cat:'reit', desc: 'REIT', ret: 0.045, crash: 0.75, color: '#a855f7', defC: 0, defF: 0 },
            { key: 'orkan', name: 'ğŸ›¡ï¸ ã‚ªãƒ«ã‚«ãƒ³', cat:'stock', desc: 'å…¨ä¸–ç•Œæ ª', ret: 0.05, crash: 0.75, color: '#10b981', defC: 50, defF: 50 },
            { key: 'sp500', name: 'âš”ï¸ S&P500', cat:'stock', desc: 'ç±³å›½TOP500', ret: 0.10, crash: 0.60, color: '#3b82f6', defC: 0, defF: 30 },
            { key: 'nasdaq', name: 'ğŸ’» NASDAQ', cat:'stock', desc: 'ãƒã‚¤ãƒ†ã‚¯æ ª', ret: 0.13, crash: 0.50, color: '#06b6d4', defC: 0, defF: 20 },
            { key: 'fang', name: 'ğŸ’ FANG+', cat:'stock', desc: 'è¶…å¤§å‹IT', ret: 0.17, crash: 0.45, color: '#f472b6', defC: 0, defF: 0 },
            { key: 'cyc', name: 'ğŸ”¥ æ™¯æ°—æ•æ„Ÿ', cat:'stock', desc: 'åŠå°ä½“ç­‰', ret: 0.15, crash: 0.45, color: '#ef4444', defC: 0, defF: 0 },
            { key: 'def', name: 'ğŸ›¡ï¸ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³', cat:'stock', desc: 'é›»åŠ›ãƒ»è–¬å“', ret: 0.06, crash: 0.75, color: '#84cc16', defC: 0, defF: 0 },
            { key: 'cryp', name: 'â‚¿ ä»®æƒ³é€šè²¨', cat:'other', desc: 'BTCç­‰', ret: 0.30, crash: 0.30, color: '#8b5cf6', defC: 0, defF: 0 },
            { key: 'lev', name: 'ğŸš€ ãƒ¬ãƒãƒŠã‚¹', cat:'other', desc: 'NASDAQÃ—2', ret: 0.25, crash: 0.25, color: '#ec4899', defC: 0, defF: 0 }
        ];

        let activeTab = 'current'; 
        let myChart = null; let modalChart = null; let pfChart = null; let rrChart = null;
        let memoCrashYears = []; let memoCrashKey = ''; let actualHistory = []; let lockedData = null;

        window.onload = () => { renderSliders('current'); renderSliders('future'); loadState(); calculate(); };

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('containerCurrent').classList.toggle('hidden', tab !== 'current');
            document.getElementById('containerFuture').classList.toggle('hidden', tab !== 'future');
            document.getElementById('tabCurrent').className = tab === 'current' ? 'flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-active' : 'flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-inactive';
            document.getElementById('tabFuture').className = tab === 'future' ? 'flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-active' : 'flex-1 py-2 rounded-lg text-[11px] font-bold tab-btn tab-inactive';
            updateTotalBar(); calculate();
        }

        function renderSliders(type) {
            const container = document.getElementById(type === 'current' ? 'slidersCurrent' : 'slidersFuture');
            container.innerHTML = ASSETS.map(a => `
                <div class="bg-slate-800/40 rounded-lg p-2 border border-slate-700/50">
                    <div class="flex justify-between items-center mb-1"><div class="flex flex-col overflow-hidden"><span style="color:${a.color}" class="font-bold text-[10px] truncate">${a.name}</span><span class="text-[8px] text-gray-500 truncate font-bold">${a.desc}</span></div><input type="number" id="num_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" oninput="syncRange('range_${type}_${a.key}', this.value)" class="num-input-small"></div>
                    <input type="range" id="range_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" class="w-full mt-0.5" oninput="syncNum('num_${type}_${a.key}', this.value)">
                </div>`).join('');
        }

        function syncNum(numId, val) { document.getElementById(numId).value = val; calculate(); }
        function syncRange(rangeId, val) { const clamped = Math.max(0, Math.min(100, val)); document.getElementById(rangeId).value = clamped; calculate(); }
        function lockComparison() { if(myChart && myChart.data.datasets.length >= 3) { const totalSet = myChart.data.datasets.find(d => d.label === 'è³‡ç”£ç·é¡'); if(totalSet) { lockedData = [...totalSet.data]; alert('ãƒ—ãƒ©ãƒ³ã‚’å›ºå®šã—ã¾ã—ãŸ'); calculate(); } } }

        function addHistory() {
            const age = Number(document.getElementById('histAge').value);
            const asset = Number(document.getElementById('histAsset').value);
            if (!age || !asset) return alert('å¹´é½¢ã¨è³‡ç”£é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            const idx = actualHistory.findIndex(h => h.age === age);
            if (idx >= 0) actualHistory[idx] = { age, asset }; else actualHistory.push({ age, asset });
            actualHistory.sort((a,b) => a.age - b.age);
            updateHistoryList(); calculate(); saveState();
            document.getElementById('histAge').value = ''; document.getElementById('histAsset').value = '';
        }
        function deleteHistory(index) { actualHistory.splice(index, 1); updateHistoryList(); calculate(); saveState(); }
        function updateHistoryList() {
            const list = document.getElementById('historyList');
            if (actualHistory.length === 0) { list.innerHTML = '<div class="text-center text-[10px] text-gray-500 py-2">å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
            list.innerHTML = actualHistory.map((h, i) => `<div class="history-item"><span class="text-gray-300 font-bold">${h.age}æ­³:</span><span class="text-orange-400 font-bold">${h.asset.toLocaleString()}ä¸‡</span><button onclick="deleteHistory(${i})" class="text-red-500 hover:text-red-400">Ã—</button></div>`).join('');
        }

        function saveState() {
            const state = { currentAge: document.getElementById('currentAge').value, initialAsset: document.getElementById('initialAsset').value, monthlyAdd: document.getElementById('monthlyAdd').value, targetAsset: document.getElementById('targetAsset').value, coastFireMode: document.getElementById('coastFireMode').checked, withdrawAge: document.getElementById('withdrawAge').value, withdrawType: document.getElementById('withdrawType').value, num_withdrawRate: document.getElementById('num_withdrawRate').value, num_withdrawAmt: document.getElementById('num_withdrawAmt').value, crashCount: document.getElementById('crashCount').value, crashTimingMode: document.getElementById('crashTimingMode').value, portfolio: {}, actualHistory: actualHistory };
            ASSETS.forEach(a => { state.portfolio[`current_${a.key}`] = document.getElementById(`range_current_${a.key}`).value; state.portfolio[`future_${a.key}`] = document.getElementById(`range_future_${a.key}`).value; });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY); if (!saved) return;
            try { const state = JSON.parse(saved); Object.keys(state).forEach(key => { if(key === 'portfolio') { Object.keys(state.portfolio).forEach(pKey => { const r=document.getElementById(`range_${pKey}`); const n=document.getElementById(`num_${pKey}`); if(r)r.value=state.portfolio[pKey]; if(n)n.value=state.portfolio[pKey]; }); } else if(key === 'coastFireMode') { document.getElementById(key).checked = state[key]; } else if(key === 'actualHistory') { actualHistory = state[key] || []; updateHistoryList(); } else { const el = document.getElementById(key); if(el) el.value = state[key]; } }); } catch (e) {}
        }
        function exportSettings() { const saved = localStorage.getItem(STORAGE_KEY); if(!saved) return alert('No Data'); const blob = new Blob([saved], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `settings.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importSettings(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e){ try{ localStorage.setItem(STORAGE_KEY, e.target.result); loadState(); calculate(); alert('Imported!'); }catch(e){alert('Error');} input.value=''; }; reader.readAsText(file); }
        function rerollCrash() { memoCrashYears = []; calculate(); }
        function applyPreset(type) { let config={}; if(type==='defensive') config={cash:20,bond:30,gold:20,orkan:30}; else if(type==='standard') config={orkan:40,sp500:60}; else if(type==='aggressive') config={nasdaq:30,fang:20,cyc:20,cryp:10,lev:20}; ASSETS.forEach(a => { const r=document.getElementById(`range_${activeTab}_${a.key}`); const n=document.getElementById(`num_${activeTab}_${a.key}`); const v=config[a.key]||0; if(r)r.value=v; if(n)n.value=v; }); calculate(); }
        function updateTotalBar() { let total=0; ASSETS.forEach(a => total += parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value)||0); document.getElementById('totalPercentDisplay').innerText = total; document.getElementById('totalProgressBar').style.width = Math.min(total, 100) + '%'; }

        function updateSubCharts(ret, crash, pfData) {
            const canvasPf = document.getElementById('portfolioChart');
            const canvasRr = document.getElementById('riskReturnChart');
            if (!canvasPf || !canvasRr) return;

            if(pfChart) pfChart.destroy();
            pfChart = new Chart(canvasPf.getContext('2d'), {
                type: 'doughnut',
                data: { labels: pfData.map(d=>d.name), datasets: [{ data: pfData.map(d=>d.val), backgroundColor: pfData.map(d=>d.color), borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
            });

            const risk = (1 - crash) * 100; const rVal = ret * 100;
            const scatterData = [ {x:0,y:0,label:'ç¾é‡‘',color:'#64748b'}, {x:25,y:5,label:'ã‚ªãƒ«ã‚«ãƒ³',color:'#10b981'}, {x:40,y:10,label:'S&P500',color:'#3b82f6'}, {x:50,y:13,label:'NASDAQ',color:'#06b6d4'}, {x:70,y:30,label:'ä»®æƒ³é€šè²¨',color:'#8b5cf6'}, {x:risk,y:rVal,label:'ã‚ãªãŸ',color:'#facc15',r:8} ];
            if(rrChart) rrChart.destroy();
            rrChart = new Chart(canvasRr.getContext('2d'), {
                type: 'scatter',
                data: { datasets: [{ label:'Assets', data:scatterData, backgroundColor:scatterData.map(d=>d.color), pointRadius:scatterData.map(d=>d.r||4) }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c=>` ${c.raw.label}` } } }, scales: { x: { display: true, min:0, max:80, grid:{color:'#334155'} }, y: { display: true, min:0, max:35, grid:{color:'#334155'} } } }
            });
        }

        function openChartModal() { document.getElementById('chartModal').style.display='flex'; if(modalChart)modalChart.destroy(); modalChart=new Chart(document.getElementById('modalChartCanvas').getContext('2d'), { type:'line', data:JSON.parse(JSON.stringify(myChart.data)), options:{ responsive:true, plugins:{legend:{display:true}}, scales:{x:{grid:{display:false}},y:{grid:{color:'#334155'}}} } }); }
        function closeChartModal() { document.getElementById('chartModal').style.display='none'; }
        function downloadChart() { const a=document.createElement('a'); a.download='sim.png'; a.href=document.getElementById('chartCanvas').toDataURL('image/png'); a.click(); }
        function shareViaEmail() { window.location.href=`mailto:?subject=SimResult&body=Check this out`; }
        function renderAchievement(age, success) { document.getElementById('achievementMobile').innerHTML = success ? `<div class="achievement-badge bg-yellow-600/80 p-4 rounded text-center"><p class="text-white text-xl">ğŸ‰ ${age}æ­³ã§é”æˆï¼</p></div>` : `<div class="bg-slate-800 p-4 rounded text-center"><p class="text-gray-400">æœªé”...</p></div>`; document.getElementById('achievementDesktop').innerHTML = document.getElementById('achievementMobile').innerHTML; }

        function calculate() {
            updateTotalBar(); saveState();
            const age = Number(document.getElementById('currentAge').value) || 35;
            const init = (Number(document.getElementById('initialAsset').value) || 0) * 10000;
            const monthly = (Number(document.getElementById('monthlyAdd').value) || 0) * 10000;
            const target = (Number(document.getElementById('targetAsset').value) || 3000) * 10000;
            const isCoast = document.getElementById('coastFireMode').checked;
            const wAge = Number(document.getElementById('withdrawAge').value) || 60;
            const wRate = (Number(document.getElementById('num_withdrawRate').value) || 0) / 100;
            const wAmt = (Number(document.getElementById('num_withdrawAmt').value) || 0) * 10000;
            const crashCount = Number(document.getElementById('crashCount').value);
            const crashMode = document.getElementById('crashTimingMode').value;

            document.getElementById('inputRateArea').classList.toggle('hidden', document.getElementById('withdrawType').value !== 'rate');
            document.getElementById('inputAmountArea').classList.toggle('hidden', document.getElementById('withdrawType').value !== 'amount');

            let retC=0, retF=0, crashC=0, crashF=0, totalC=0, totalF=0;
            let pfData=[];
            ASSETS.forEach(a => { const val=parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value)||0; if(activeTab==='current') totalC+=val; else totalF+=val; if(val>0) pfData.push({name:a.name, val:val, color:a.color}); });
            ASSETS.forEach(a => { if(totalC>0 && activeTab==='current'){ const w=parseInt(document.getElementById(`range_current_${a.key}`).value)/totalC; retC+=a.ret*w; crashC+=a.crash*w; } if(totalF>0 && activeTab==='future'){ const w=parseInt(document.getElementById(`range_future_${a.key}`).value)/totalF; retF+=a.ret*w; crashF+=a.crash*w; } });

            updateSubCharts(activeTab==='current'?retC:retF, activeTab==='current'?crashC:crashF, pfData);

            document.getElementById('tabRetCurrent').innerText = (retC*100).toFixed(1); document.getElementById('tabRetFuture').innerText = (retF*100).toFixed(1);
            const riskValC = crashC > 0 ? -(1-crashC)*100 : 0; const riskValF = crashF > 0 ? -(1-crashF)*100 : 0;
            document.getElementById('specTotalRet').innerText = ((retC+retF)/2 * 100).toFixed(1); // ç°¡æ˜“è¡¨ç¤º
            document.getElementById('specTotalCrash').innerText = riskValC.toFixed(1); // ç°¡æ˜“è¡¨ç¤º

            let hAge=[age], hPrin=[init/10000], hTotal=[init/10000];
            let cA=init, cAcc=0, cP=init, peak=init, gAge=null, rAge=null;

            if (crashCount > 0) {
                const key = `${age}-${crashCount}-${crashMode}`;
                if (memoCrashKey !== key || memoCrashYears.length === 0) {
                    let arr = Array.from({length: 100-age}, (_, i) => i+1);
                    if(crashMode==='random') arr.sort(() => Math.random()-0.5);
                    else if(crashMode==='early') arr = arr.map((_,i)=>(i+1)*2);
                    else arr = arr.reverse().map((_,i)=>(i+1)*2);
                    memoCrashYears = arr.slice(0, crashCount); memoCrashKey = key;
                }
            } else { memoCrashYears = []; memoCrashKey = ''; }

            for(let i=1; i<=100-age; i++){
                const isCr = memoCrashYears.includes(i);
                if((cA+cAcc)>=target && !rAge) rAge=age+i-1;
                if(isCoast && (cA+cAcc)>=target && !gAge) gAge=age+i-1;
                let add=0; if(age+i<wAge && !gAge) { add=monthly*12; cP+=add; }
                if(age+i<wAge) { cA*=isCr?crashC:(1+retC); cAcc=(cAcc+add)*(isCr?crashF:(1+retF)); }
                else {
                    let tot=cA+cAcc; let wAmtCalc=(document.getElementById('withdrawType').value==='rate'?tot*wRate:wAmt*12);
                    if(tot>0){ let r=wAmtCalc/tot; if(r>1)r=1; cP-=cP*r; }
                    tot=Math.max(0, tot-wAmtCalc);
                    tot*=isCr?(cA*crashC+cAcc*crashF)/(cA+cAcc||1):(1+(cA*retC+cAcc*retF)/(cA+cAcc||1));
                    cA=tot*(cA/(cA+cAcc||1)); cAcc=tot-cA;
                }
                const totalNow = cA+cAcc; peak=Math.max(peak, totalNow); 
                hAge.push(age+i); hPrin.push(Math.round(cP/10000)); hTotal.push(Math.round(totalNow/10000));
            }

            document.getElementById('resPeakAsset').innerText = Math.round(peak/10000).toLocaleString();
            document.getElementById('resEndAsset').innerText = hTotal[hTotal.length-1].toLocaleString();
            document.getElementById('graduationAgeArea').classList.toggle('hidden', !gAge);
            if(gAge) document.getElementById('graduationAge').innerText=gAge;
            renderAchievement(rAge, !!rAge);

            if(actualHistory.length>0){
                const last = actualHistory[actualHistory.length-1];
                const sIdx = hAge.indexOf(last.age);
                if(sIdx>=0) {
                    const diff = last.asset - hTotal[sIdx];
                    document.getElementById('gapDisplay').innerHTML = `è¨ˆç”»æ¯” <span class="${diff>=0?'text-green-400':'text-red-400'}">${diff>=0?'+':''}${diff.toLocaleString()}ä¸‡</span>`;
                } else document.getElementById('gapDisplay').innerText='';
            } else document.getElementById('gapDisplay').innerText='';

            const actualData = hAge.map(h => { const hit=actualHistory.find(a=>a.age===h); return hit?hit.asset:null; });
            
            const datasets = [
                { type:'line', label:'è³‡ç”£ç·é¡', data:hTotal, borderColor:'#3b82f6', backgroundColor:'rgba(59, 130, 246, 0.6)', fill:true, pointRadius:0, borderWidth:2, order:3 },
                { type:'line', label:'å…ƒæœ¬', data:hPrin, borderColor:'#64748b', backgroundColor:'rgba(15, 23, 42, 0.8)', fill:true, pointRadius:0, borderWidth:1, order:2 },
                { type:'line', label:'å®Ÿç¸¾', data:actualData, borderColor:'#fb923c', backgroundColor:'#fb923c', pointRadius:4, borderWidth:3, fill:false, order:0 },
            ];
            
            if(lockedData) {
                datasets.push({ type:'line', label:'æ¯”è¼ƒ(å‰å›)', data:lockedData, borderColor:'rgba(255,255,255,0.5)', borderDash:[5,5], pointRadius:0, fill:false, order:1 });
            }

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('chartCanvas').getContext('2d'), {
                type:'line', data:{labels:hAge, datasets:datasets},
                options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#94a3b8'}}}, scales:{x:{grid:{display:false},ticks:{color:'#64748b'}},y:{grid:{color:'#1e293b'},ticks:{color:'#64748b'}}}, interaction:{mode:'index',axis:'x',intersect:false} }
            });
        }
    </script>
</body>
</html>
