<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>simulator8</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; }
        .input-card { background-color: #1e293b; border: 1px solid #334155; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 24px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; border-radius: 3px; background: #334155; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #fff; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.5); border: 2px solid #cbd5e1; }
        .slider-exit { width: 100%; }
        .tab-active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .tab-inactive { background-color: #1e293b; color: #94a3b8; border-color: #475569; }
        .sticky-result { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); border-top: 1px solid #334155; padding: 10px; z-index: 50; }
        .num-input { background: #0f172a; border: 1px solid #475569; color: white; border-radius: 4px; padding: 1px 4px; width: 45px; text-align: right; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="mb-4 text-center">
        <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 via-blue-500 to-purple-500">simulator8</h1>
        <p class="text-[10px] text-gray-400">v3.3 è¨˜éŒ²æ©Ÿèƒ½å¾©å…ƒç‰ˆ</p>
    </header>

    <div class="input-card p-3 rounded-xl shadow-lg mb-4 space-y-3">
        <div class="grid grid-cols-2 gap-2">
            <div><label class="text-[10px] text-gray-400 block mb-0.5">ç¾åœ¨ã®å¹´é½¢</label><div class="relative"><input type="number" id="currentAge" value="35" oninput="calculate()" class="w-full p-1.5 bg-slate-800 border border-slate-600 rounded text-white font-bold text-center text-sm"><span class="absolute right-2 top-1.5 text-[10px] text-gray-500">æ­³</span></div></div>
            <div><label class="text-[10px] text-gray-400 block mb-0.5">ç¾åœ¨è³‡ç”£</label><div class="relative"><input type="number" id="initialAsset" value="1000" oninput="calculate()" class="w-full p-1.5 bg-slate-800 border border-slate-600 rounded text-white font-bold text-center text-sm"><span class="absolute right-2 top-1.5 text-[10px] text-gray-500">ä¸‡</span></div></div>
            <div><label class="text-[10px] text-gray-400 block mb-0.5">æ¯æœˆç©ç«‹</label><div class="relative"><input type="number" id="monthlyAdd" value="10" oninput="calculate()" class="w-full p-1.5 bg-slate-800 border border-slate-600 rounded text-white font-bold text-center text-sm"><span class="absolute right-2 top-1.5 text-[10px] text-gray-500">ä¸‡</span></div></div>
            <div><label class="text-[10px] text-yellow-400 block mb-0.5">ç›®æ¨™é‡‘é¡</label><div class="relative"><input type="number" id="targetAsset" value="3000" step="100" oninput="calculate()" class="w-full p-1.5 bg-slate-800 border border-yellow-500/50 rounded text-yellow-100 font-bold text-center text-sm"><span class="absolute right-2 top-1.5 text-[10px] text-gray-500">ä¸‡</span></div></div>
        </div>
        <div class="flex items-center justify-between bg-slate-700/30 p-2 rounded-lg border border-slate-600/50">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="coastFireMode" onchange="calculate()" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <label for="coastFireMode" class="text-xs font-bold text-white cursor-pointer text-[10px]">ç›®æ¨™é”æˆã§ç©ç«‹åœæ­¢ (Coast FIRE)</label>
            </div>
            <div id="graduationAgeArea" class="hidden text-xs font-bold text-yellow-400">ğŸ‰ <span id="graduationAge">0</span>æ­³ã§å’æ¥­</div>
        </div>
    </div>

    <div class="mb-4">
        <div class="input-card p-3 rounded-xl shadow-lg">
            <h2 class="text-xs font-bold text-gray-300 mb-2 font-bold text-[10px]">âš™ï¸ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªé…åˆ†</h2>
            
            <div class="flex gap-2 mb-3">
                <button id="tabCurrent" onclick="switchTab('current')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border tab-active transition">ä»Šã®è³‡ç”£</button>
                <button id="tabFuture" onclick="switchTab('future')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border tab-inactive transition">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</button>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="applyPreset('defensive')" class="bg-emerald-900/40 border border-emerald-500/30 text-emerald-200 text-[9px] py-2 rounded hover:bg-emerald-800/50">ğŸ›¡ï¸ é‰„å£</button>
                <button onclick="applyPreset('standard')" class="bg-blue-900/40 border border-blue-500/30 text-blue-200 text-[9px] py-2 rounded hover:bg-blue-800/50">ğŸ‘‘ ç‹é“</button>
                <button onclick="applyPreset('aggressive')" class="bg-purple-900/40 border border-purple-500/30 text-purple-200 text-[9px] py-2 rounded hover:bg-purple-800/50">ğŸš€ çˆ†ç›Š</button>
            </div>

            <div class="mb-3 bg-slate-900 rounded-full h-5 relative overflow-hidden border border-slate-700">
                <div id="totalProgressBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 100%"></div>
                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-[10px] font-bold">åˆè¨ˆ: <span id="totalPercentDisplay">100</span>%</div>
            </div>

            <div id="containerCurrent" class="block"><div id="slidersCurrent" class="grid grid-cols-2 gap-2"></div></div>
            <div id="containerFuture" class="hidden"><div id="slidersFuture" class="grid grid-cols-2 gap-2"></div></div>

            <div class="mt-4 pt-3 border-t border-slate-600 grid grid-cols-2 gap-2 text-center text-xs">
                <div class="bg-slate-800/50 p-1 rounded">
                    <p class="text-[9px] text-gray-400 font-bold">ç¾åœ¨ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</p>
                    <p class="text-blue-300 font-bold text-[10px]">å¹´åˆ©: <span id="tabRetCurrent">0.0</span>%</p>
                    <p class="text-red-400 font-bold text-[10px]">ãƒªã‚¹ã‚¯: <span id="tabCrashCurrent">0.0</span>%</p>
                </div>
                <div class="bg-slate-800/50 p-1 rounded">
                    <p class="text-[9px] text-gray-400 font-bold">ã“ã‚Œã‹ã‚‰ã®ç©ç«‹</p>
                    <p class="text-green-300 font-bold text-[10px]">å¹´åˆ©: <span id="tabRetFuture">0.0</span>%</p>
                    <p class="text-red-400 font-bold text-[10px]">ãƒªã‚¹ã‚¯: <span id="tabCrashFuture">0.0</span>%</p>
                </div>
            </div>
        </div>

        <div class="mt-2 pt-2">
            <div class="bg-slate-800 p-3 rounded-lg border border-indigo-500/50 text-center shadow-lg">
                <p class="text-[10px] text-indigo-300 mb-1 font-bold">è³‡ç”£å…¨ä½“ã®ç·åˆã‚¹ãƒšãƒƒã‚¯ (10å¹´å¾Œç›®å®‰)</p>
                <div class="flex justify-center items-center gap-6">
                    <div>
                        <p class="text-[9px] text-gray-400 font-bold">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</p>
                        <p class="text-3xl font-bold text-white"><span id="specTotalRet">0.0</span>%</p>
                    </div>
                    <div class="h-10 w-px bg-slate-600"></div>
                    <div>
                        <p class="text-[9px] text-red-300 font-bold">æš´è½æ™‚ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
                        <p class="text-3xl font-bold text-red-400"><span id="specTotalCrash">0.0</span>%</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="input-card p-4 rounded-xl shadow-lg mb-4 bg-gradient-to-br from-slate-900 to-slate-800 border-indigo-500/30">
        <h2 class="text-sm font-bold text-indigo-300 mb-3 flex items-center font-bold text-[12px]"><span class="text-xl mr-2">ğŸšª</span> å‡ºå£æˆ¦ç•¥ (å–ã‚Šå´©ã—)</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="text-[10px] text-gray-400 block mb-1">é–‹å§‹å¹´é½¢</label><input type="number" id="withdrawAge" value="60" oninput="calculate()" class="w-full p-2 bg-slate-900 border border-indigo-500/50 rounded text-white text-center font-bold"></div>
            <div><label class="text-[10px] text-gray-400 block mb-1">æ–¹æ³•</label><select id="withdrawType" onchange="calculate()" class="w-full p-2 bg-slate-900 border border-indigo-500/50 rounded text-white text-center text-xs font-bold h-[42px]"><option value="rate">å®šç‡ (ï¼…)</option><option value="amount">å®šé¡ (ä¸‡å††)</option></select></div>
        </div>
        
        <div id="inputRateArea" class="block bg-indigo-900/20 rounded-xl p-3 border border-indigo-500/30">
            <div class="flex justify-between items-center mb-2">
                <label class="text-xs font-bold text-indigo-200 text-[10px]">æ¯å¹´å¼•ãå‡ºã™å‰²åˆ (%)</label>
                <input type="number" id="num_withdrawRate" value="4.0" step="0.1" oninput="syncRange('withdrawRateRange', this.value)" class="num-input">
            </div>
            <input type="range" id="withdrawRateRange" min="0" max="10" step="0.1" value="4.0" oninput="syncNum('num_withdrawRate', this.value)">
        </div>

        <div id="inputAmountArea" class="hidden bg-indigo-900/20 rounded-xl p-3 border border-indigo-500/30">
            <div class="flex justify-between items-center mb-2">
                <label class="text-xs font-bold text-indigo-200 text-[10px]">æ¯æœˆå¼•ãå‡ºã™é‡‘é¡ (ä¸‡)</label>
                <input type="number" id="num_withdrawAmt" value="20" oninput="syncRange('withdrawAmountRange', this.value)" class="num-input">
            </div>
            <input type="range" id="withdrawAmountRange" min="0" max="100" step="1" value="20" oninput="syncNum('num_withdrawAmt', this.value)">
        </div>
    </div>

    <div class="input-card p-3 rounded-xl shadow-lg mb-4 bg-red-900/10 border-red-900/30">
        <h2 class="text-xs font-bold text-red-300 mb-2 font-bold text-[10px]">ğŸ“‰ æš´è½è¨­å®š</h2>
        <div class="grid grid-cols-2 gap-2">
            <select id="crashCount" onchange="calculate()" class="w-full p-2 bg-slate-800 rounded border border-red-900/50 text-white text-xs text-center"><option value="0">ãªã—</option><option value="2">2å›</option><option value="5" selected>5å›</option><option value="8">8å›</option></select>
            <div class="flex gap-1"><select id="crashTimingMode" onchange="calculate()" class="w-full p-2 bg-slate-800 rounded border border-red-900/50 text-white text-xs text-center flex-1"><option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option><option value="early">åºç›¤é›†ä¸­</option><option value="late">çµ‚ç›¤é›†ä¸­</option></select><button onclick="rerollCrash()" class="bg-slate-700 px-3 rounded text-lg">ğŸ²</button></div>
        </div>
    </div>

    <div class="bg-white/5 p-2 rounded-xl border border-white/10 mb-4 relative h-[300px]"><canvas id="chartCanvas"></canvas></div>

    <div class="space-y-2 mb-8">
        <a href="https://www.a8.net/" target="_blank" class="block bg-gradient-to-r from-blue-700 to-blue-600 p-3 rounded-lg text-center text-white shadow-lg hover:opacity-90 transition transform active:scale-95 border border-blue-400/30"><span class="font-bold text-xs">SBIè¨¼åˆ¸ å£åº§é–‹è¨­ã¯ã“ã¡ã‚‰ï¼ˆPRï¼‰</span></a>
        <a href="https://www.a8.net/" target="_blank" class="block bg-gradient-to-r from-emerald-700 to-emerald-600 p-3 rounded-lg text-center text-white shadow-lg hover:opacity-90 transition transform active:scale-95 border border-emerald-400/30"><span class="font-bold text-xs">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ï¼ˆNLï¼‰ã‚’ä½œã‚‹ï¼ˆPRï¼‰</span></a>
    </div>

    <footer class="text-center text-[10px] text-gray-500 border-t border-slate-800 pt-4 pb-20">
        <div class="flex justify-center gap-4 mb-2"><a href="privacy.html" class="underline">é‹å–¶è€…æƒ…å ±</a><a href="privacy.html" class="underline">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></div>
        <p>&copy; 2026 simulator8</p>
    </footer>

    <div class="sticky-result"><div class="max-w-md mx-auto grid grid-cols-2 gap-4 text-center"><div><p class="text-[9px] text-gray-400 font-bold">è³‡ç”£ãƒ”ãƒ¼ã‚¯</p><p class="text-lg font-bold text-yellow-400"><span id="resPeakAsset">0</span><span class="text-xs">ä¸‡</span></p></div><div><p class="text-[9px] text-gray-400 font-bold">100æ­³æ™‚ç‚¹</p><p class="text-sm font-bold text-white"><span id="resEndAsset">0</span><span class="text-xs">ä¸‡</span></p></div></div></div>

    <script>
        const ASSETS = [
            { key: 'cash', name: 'ğŸ’´ ç¾é‡‘', desc: 'æ—¥æœ¬å††', ret: 0.00, crash: 1.00, color: '#94a3b8', defC: 50, defF: 0 },
            { key: 'bond', name: 'ğŸ“œ å‚µåˆ¸', desc: 'ç±³å›½å‚µç­‰', ret: 0.03, crash: 0.95, color: '#14b8a6', defC: 0, defF: 0 },
            { key: 'gold', name: 'ğŸ¥‡ é‡‘',   desc: 'å®‰å…¨è³‡ç”£', ret: 0.04, crash: 0.85, color: '#eab308', defC: 0, defF: 0 },
            { key: 'reit', name: 'ğŸ¢ ä¸å‹•ç”£', desc: 'REIT', ret: 0.045, crash: 0.75, color: '#a16207', defC: 0, defF: 0 },
            { key: 'orkan', name: 'ğŸ›¡ï¸ ã‚ªãƒ«ã‚«ãƒ³', desc: 'å…¨ä¸–ç•Œæ ª', ret: 0.05, crash: 0.75, color: '#10b981', defC: 50, defF: 50 },
            { key: 'sp500', name: 'âš”ï¸ S&P500', desc: 'ç±³å›½TOP500', ret: 0.10, crash: 0.60, color: '#3b82f6', defC: 0, defF: 30 },
            { key: 'nasdaq', name: 'ğŸ’» NASDAQ100', desc: 'ãƒã‚¤ãƒ†ã‚¯æ ª', ret: 0.13, crash: 0.50, color: '#06b6d4', defC: 0, defF: 20 },
            { key: 'fang', name: 'ğŸ’ FANG+', desc: 'è¶…å¤§å‹IT', ret: 0.17, crash: 0.45, color: '#f97316', defC: 0, defF: 0 },
            { key: 'cyc', name: 'ğŸ”¥ æ™¯æ°—æ•æ„Ÿæ ª', desc: 'åŠå°ä½“ãƒ»è‡ªå‹•è»Š', ret: 0.15, crash: 0.45, color: '#ef4444', defC: 0, defF: 0 },
            { key: 'def', name: 'ğŸ›¡ï¸ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–æ ª', desc: 'é›»åŠ›ãƒ»è–¬å“ç­‰', ret: 0.06, crash: 0.75, color: '#84cc16', defC: 0, defF: 0 },
            { key: 'cryp', name: 'â‚¿ ä»®æƒ³é€šè²¨', desc: 'BTCç­‰', ret: 0.30, crash: 0.30, color: '#6366f1', defC: 0, defF: 0 },
            { key: 'lev', name: 'ğŸš€ ãƒ¬ãƒãƒŠã‚¹', desc: 'NASDAQÃ—2', ret: 0.25, crash: 0.25, color: '#a855f7', defC: 0, defF: 0 }
        ];

        let activeTab = 'current'; let myChart = null; let memoCrashYears = []; let memoCrashKey = '';

        window.onload = () => {
            renderSliders('current');
            renderSliders('future');
            loadState(); // è¨˜éŒ²ã‹ã‚‰å¾©å…ƒ
            calculate();
        };

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('containerCurrent').classList.toggle('hidden', tab !== 'current');
            document.getElementById('containerFuture').classList.toggle('hidden', tab !== 'future');
            document.getElementById('tabCurrent').className = tab === 'current' ? 'flex-1 py-2 rounded-lg text-[10px] font-bold border tab-active' : 'flex-1 py-2 rounded-lg text-[10px] font-bold border tab-inactive';
            document.getElementById('tabFuture').className = tab === 'future' ? 'flex-1 py-2 rounded-lg text-[10px] font-bold border tab-active' : 'flex-1 py-2 rounded-lg text-[10px] font-bold border tab-inactive';
            updateTotalBar();
        }

        function renderSliders(type) {
            const container = document.getElementById(type === 'current' ? 'slidersCurrent' : 'slidersFuture');
            container.innerHTML = ASSETS.map(a => `
                <div class="bg-slate-700/20 rounded-lg p-2 border border-slate-600/30">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex flex-col overflow-hidden">
                            <span style="color:${a.color}" class="font-bold text-[10px] truncate">${a.name}</span>
                            <span class="text-[8px] text-gray-400 truncate font-bold">${a.desc}</span>
                        </div>
                        <input type="number" id="num_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" oninput="syncRange('range_${type}_${a.key}', this.value)" class="num-input flex-shrink-0 ml-1">
                    </div>
                    <input type="range" id="range_${type}_${a.key}" value="${type==='current'?a.defC:a.defF}" min="0" max="100" class="w-full mt-0.5" oninput="syncNum('num_${type}_${a.key}', this.value)">
                </div>`).join('');
        }

        function syncNum(numId, val) { document.getElementById(numId).value = val; calculate(); }
        function syncRange(rangeId, val) { 
            const clamped = Math.max(0, Math.min(100, val));
            document.getElementById(rangeId).value = clamped; 
            calculate(); 
        }

        // ä¿å­˜æ©Ÿèƒ½
        function saveState() {
            const state = {
                currentAge: document.getElementById('currentAge').value,
                initialAsset: document.getElementById('initialAsset').value,
                monthlyAdd: document.getElementById('monthlyAdd').value,
                targetAsset: document.getElementById('targetAsset').value,
                coastFireMode: document.getElementById('coastFireMode').checked,
                withdrawAge: document.getElementById('withdrawAge').value,
                withdrawType: document.getElementById('withdrawType').value,
                num_withdrawRate: document.getElementById('num_withdrawRate').value,
                num_withdrawAmt: document.getElementById('num_withdrawAmt').value,
                crashCount: document.getElementById('crashCount').value,
                crashTimingMode: document.getElementById('crashTimingMode').value,
                portfolio: {}
            };
            ASSETS.forEach(a => {
                state.portfolio[`current_${a.key}`] = document.getElementById(`range_current_${a.key}`).value;
                state.portfolio[`future_${a.key}`] = document.getElementById(`range_future_${a.key}`).value;
            });
            localStorage.setItem('simulatorState', JSON.stringify(state));
        }

        // èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadState() {
            const saved = localStorage.getItem('simulatorState');
            if (!saved) return;
            const state = JSON.parse(saved);
            Object.keys(state).forEach(key => {
                if(key === 'portfolio') {
                    Object.keys(state.portfolio).forEach(pKey => {
                        const elRange = document.getElementById(`range_${pKey}`);
                        const elNum = document.getElementById(`num_${pKey}`);
                        if(elRange) elRange.value = state.portfolio[pKey];
                        if(elNum) elNum.value = state.portfolio[pKey];
                    });
                } else if(key === 'coastFireMode') {
                    document.getElementById(key).checked = state[key];
                } else {
                    const el = document.getElementById(key);
                    if(el) el.value = state[key];
                }
            });
        }

        function rerollCrash() { memoCrashYears = []; calculate(); }

        function applyPreset(type) {
            let config = {};
            if (type === 'defensive') config = { cash: 20, bond: 30, gold: 20, orkan: 30 };
            else if (type === 'standard') config = { orkan: 40, sp500: 60 };
            else if (type === 'aggressive') config = { nasdaq: 30, fang: 20, cyc: 20, cryp: 10, lev: 20 };
            
            ASSETS.forEach(a => {
                const rangeId = `range_${activeTab}_${a.key}`;
                const numId = `num_${activeTab}_${a.key}`;
                const val = config[a.key] || 0;
                if(document.getElementById(rangeId)) {
                    document.getElementById(rangeId).value = val;
                    document.getElementById(numId).value = val;
                }
            });
            calculate();
        }

        function updateTotalBar() {
            let total = 0;
            ASSETS.forEach(a => total += parseInt(document.getElementById(`range_${activeTab}_${a.key}`).value) || 0);
            document.getElementById('totalPercentDisplay').innerText = total;
            document.getElementById('totalProgressBar').style.width = Math.min(total, 100) + '%';
        }

        function calculate() {
            updateTotalBar();
            saveState(); // å¤‰æ›´ã®ãŸã³ã«è¨˜éŒ²
            const age = Number(document.getElementById('currentAge').value) || 35;
            const init = (Number(document.getElementById('initialAsset').value) || 0) * 10000;
            const monthly = (Number(document.getElementById('monthlyAdd').value) || 0) * 10000;
            const target = (Number(document.getElementById('targetAsset').value) || 3000) * 10000;
            const isCoast = document.getElementById('coastFireMode').checked;
            const wAge = Number(document.getElementById('withdrawAge').value) || 60;
            const wRate = (Number(document.getElementById('num_withdrawRate').value) || 0) / 100;
            const wAmt = (Number(document.getElementById('num_withdrawAmt').value) || 0) * 10000;
            const crashCount = Number(document.getElementById('crashCount').value);
            const crashMode = document.getElementById('crashTimingMode').value;

            document.getElementById('inputRateArea').classList.toggle('hidden', document.getElementById('withdrawType').value !== 'rate');
            document.getElementById('inputAmountArea').classList.toggle('hidden', document.getElementById('withdrawType').value !== 'amount');

            let retC = 0, retF = 0, crashC = 0, crashF = 0, totalC = 0, totalF = 0;
            ASSETS.forEach(a => {
                const vc = parseInt(document.getElementById(`range_current_${a.key}`).value)||0;
                const vf = parseInt(document.getElementById(`range_future_${a.key}`).value)||0;
                totalC += vc; totalF += vf;
            });
            ASSETS.forEach(a => {
                if(totalC>0){ const w=parseInt(document.getElementById(`range_current_${a.key}`).value)/totalC; retC+=a.ret*w; crashC+=a.crash*w; }
                if(totalF>0){ const w=parseInt(document.getElementById(`range_future_${a.key}`).value)/totalF; retF+=a.ret*w; crashF+=a.crash*w; }
            });

            document.getElementById('tabRetCurrent').innerText = (retC*100).toFixed(1);
            document.getElementById('tabCrashCurrent').innerText = (crashC > 0 ? -(1-crashC)*100 : 0).toFixed(1);
            document.getElementById('tabRetFuture').innerText = (retF*100).toFixed(1);
            document.getElementById('tabCrashFuture').innerText = (crashF > 0 ? -(1-crashF)*100 : 0).toFixed(1);

            const futureInit = init * Math.pow(1+retC, 10);
            const futureAdd = (monthly * 12) * ((Math.pow(1+retF, 10)-1) / (retF || 0.0001));
            const total10 = futureInit + futureAdd;
            let finalRet = 0, finalCrash = 0;
            if(total10 > 0) {
                finalRet = (retC * futureInit + retF * futureAdd) / total10;
                finalCrash = (crashC * futureInit + crashF * futureAdd) / total10;
            }
            document.getElementById('specTotalRet').innerText = (finalRet * 100).toFixed(1);
            document.getElementById('specTotalCrash').innerText = (finalCrash > 0 ? -(1-finalCrash)*100 : 0).toFixed(1);

            let historyAge = [age], historyAsset = [init/10000], currA = init, currAcc = 0, peak = init, gradAge = null;
            
            let crashYears = [];
            if (crashCount > 0) {
                const key = `${age}-${crashCount}-${crashMode}`;
                if (memoCrashKey !== key || memoCrashYears.length === 0) {
                    let arr = Array.from({length: 100-age}, (_, i) => i+1);
                    if(crashMode==='random') arr.sort(() => Math.random()-0.5);
                    else if(crashMode==='early') arr = arr.map((_,i)=>(i+1)*2);
                    else arr = arr.reverse().map((_,i)=>(i+1)*2);
                    memoCrashYears = arr.slice(0, crashCount); memoCrashKey = key;
                }
                crashYears = memoCrashYears;
            }

            for(let i=1; i<=100-age; i++){
                const isCr = crashYears.includes(i);
                if(isCoast && (currA+currAcc) >= target && !gradAge) gradAge = age+i-1;
                if(age+i < wAge){
                    currA *= isCr ? crashC : (1+retC);
                    currAcc = (currAcc + (gradAge?0:monthly*12)) * (isCr ? crashF : (1+retF));
                } else {
                    let total = currA + currAcc;
                    total = Math.max(0, total - (document.getElementById('withdrawType').value==='rate'?total*wRate:wAmt*12));
                    total *= isCr ? (currA*crashC+currAcc*crashF)/(currA+currAcc||1) : (1+(currA*retC+currAcc*retF)/(currA+currAcc||1));
                    currA = total * (currA/(currA+currAcc||1)); currAcc = total - currA;
                }
                const totalNow = currA+currAcc; peak = Math.max(peak, totalNow);
                historyAge.push(age+i); historyAsset.push(Math.round(totalNow/10000));
            }

            document.getElementById('resPeakAsset').innerText = Math.round(peak/10000).toLocaleString();
            document.getElementById('resEndAsset').innerText = historyAsset[historyAsset.length-1].toLocaleString();
            document.getElementById('graduationAgeArea').classList.toggle('hidden', !gradAge);
            if(gradAge) document.getElementById('graduationAge').innerText = gradAge;

            if(myChart){ myChart.data.labels = historyAge; myChart.data.datasets[0].data = historyAsset; myChart.update(); }
            else { myChart = new Chart(document.getElementById('chartCanvas'), { type: 'line', data: { labels: historyAge, datasets: [{ data: historyAsset, borderColor: '#3b82f6', fill: true, backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#334155' } } } } }); }
        }
    </script>
</body>
</html>
